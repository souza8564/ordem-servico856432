<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ordens de Servi√ßo Interno</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #a9a9a9;
            -webkit-tap-highlight-color: transparent;
        }
        .main-layout {
            display: flex;
            min-height: 100vh;
            flex-direction: row;
        }
        .sidebar {
            width: 220px;
            background: #222;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding-top: 0;
            box-shadow: 2px 0 8px #0002;
            z-index: 10;
        }
        .sidebar-header {
            background:#39ff14;
            color:#111;
            text-align:center;
            border-radius:0 0 8px 8px;
            padding:24px 0 10px 0;
            box-shadow:0 0 8px #39ff14;
            margin-bottom: 18px;
            font-family:sans-serif;
            font-size:2em;
            letter-spacing:2px;
            font-weight:bold;
        }
        .sidebar-header .subtitle {
            font-size:0.8em;
            color:#00843d;
            font-weight:normal;
            display:block;
            margin-top:-2px;
            font-style:italic;
        }
        .sidebar-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.08em;
            padding: 14px 24px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            text-align: left;
        }
        .sidebar-btn.active, .sidebar-btn:hover {
            background: #39ff14;
            color: #222;
        }
        .sidebar-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 32px 32px 32px;
            flex: 1;
            box-sizing: border-box;
        }
        .tabcontent {
            display: none;
            padding: 0;
            border: none;
            border-radius: 0;
            background: none;
            animation: fadeEffect 0.7s;
        }
        .tabcontent.active {
            display: block;
        }
        /* Estilos para formul√°rios */
        .os-card {
            max-width: 700px;
            margin: 0 auto 32px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px #0001;
            padding: 32px 32px 24px 32px;
        }
        .os-card h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 24px;
            color: #00843d;
        }
        .os-card form {
            display: flex;
            flex-wrap: wrap;
            gap: 24px 32px;
        }
        .form-group {
            flex: 1 1 220px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        label {
            font-weight: 500;
            color: #222;
        }
        input[type="text"],
        input[type="date"],
        input[type="tel"],
        select,
        textarea {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            background: #f9f9f9;
            transition: border 0.2s;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            border: 1.5px solid #39ff14;
            outline: none;
        }
        button[type="submit"] {
            width: 100%;
            margin-top: 12px;
            padding: 12px 0;
            background: linear-gradient(90deg,#39ff14 60%,#00843d 100%);
            color: #111;
            font-weight: bold;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px #39ff1422;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        button[type="submit"]:hover {
            background: linear-gradient(90deg,#00843d 0%,#39ff14 100%);
            color: #fff;
        }
        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-edit {
            background-color: #00843d;
            color: white;
            margin-right: 5px;
        }
        .btn-delete {
            background-color: #d00;
            color: white;
        }
        .btn-print {
            background-color: #39f;
            color: white;
        }
        /* Status da OS */
        .status-pendente {
            color: #d00;
            font-weight: bold;
        }
        .status-andamento {
            color: #f90;
            font-weight: bold;
        }
        .status-concluida {
            color: #00843d;
            font-weight: bold;
        }
        .status-cancelada {
            color: #888;
            font-weight: bold;
        }
        /* Responsividade */
        @media (max-width: 900px) {
            .main-layout {
                flex-direction: column;
            }
            .sidebar {
                flex-direction: row;
                width: 100vw;
                height: auto;
                min-width: 0;
                max-width: 100vw;
                overflow-x: auto;
                box-shadow: 0 2px 8px #0002;
                border-radius: 0 0 12px 12px;
                padding: 0;
            }
            .sidebar-header {
                display: none;
            }
            .sidebar-menu {
                flex-direction: row;
                gap: 0;
                width: 100vw;
                overflow-x: auto;
            }
            .sidebar-btn {
                flex: 1 1 120px;
                min-width: 120px;
                font-size: 1em;
                padding: 12px 4px;
                justify-content: center;
                border-radius: 0;
                border-right: 1px solid #333;
            }
            .sidebar-btn:last-child {
                border-right: none;
            }
        }
        @media (max-width: 700px) {
            html {
                font-size: 15px;
            }
            .container {
                max-width: 100vw;
                padding: 4vw 0 18vw 0;
            }
            .os-card {
                padding: 10px 2vw 10px 2vw;
                max-width: 100vw;
                box-sizing: border-box;
            }
            .os-card form {
                flex-direction: column;
                gap: 12px;
                padding: 0;
            }
            .form-group {
                min-width: 0;
                width: 100%;
            }
            table {
                font-size: 0.97em;
            }
            th, td {
                padding: 6px 2px;
            }
            .sidebar {
                font-size: 0.95em;
            }
        }
        @media (max-width: 520px) {
            html {
                font-size: 14px;
            }
            .container {
                padding: 1vw 0 12vw 0;
            }
            .os-card {
                padding: 4px 0 4px 0;
            }
            table, th, td {
                font-size: 0.92em;
            }
            .sidebar-btn {
                min-width: 80px;
                font-size: 0.91em;
                padding: 8px 1px;
            }
        }
        /* Tabela responsiva */
        @media (max-width: 700px) {
            table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            thead {
                display: none;
            }
            tbody, tr, td {
                display: block;
                width: 100%;
            }
            tr {
                margin-bottom: 14px;
                border-radius: 10px;
                box-shadow: 0 1px 6px #0001;
                background: #fff;
                padding: 10px 0;
            }
            td {
                border: none;
                position: relative;
                padding-left: 46%;
                min-height: 32px;
                box-sizing: border-box;
                margin-bottom: 6px;
            }
            td:before {
                position: absolute;
                left: 8px;
                top: 8px;
                width: 44%;
                white-space: nowrap;
                font-weight: bold;
                color: #00843d;
                font-size: 0.98em;
            }
            #tabela-solicitantes td:nth-child(1):before { content: 'Nome'; }
            #tabela-solicitantes td:nth-child(2):before { content: 'Setor'; }
            #tabela-solicitantes td:nth-child(3):before { content: 'Contato'; }
            #tabela-solicitantes td:nth-child(4):before { content: 'A√ß√µes'; }
            
            #tabela-tecnicos td:nth-child(1):before { content: 'Nome'; }
            #tabela-tecnicos td:nth-child(2):before { content: 'Especialidade'; }
            #tabela-tecnicos td:nth-child(3):before { content: 'Contato'; }
            #tabela-tecnicos td:nth-child(4):before { content: 'A√ß√µes'; }
            
            #tabela-os td:nth-child(1):before { content: 'N√∫mero'; }
            #tabela-os td:nth-child(2):before { content: 'Solicitante'; }
            #tabela-os td:nth-child(3):before { content: 'Setor'; }
            #tabela-os td:nth-child(4):before { content: 'Equipamento'; }
            #tabela-os td:nth-child(5):before { content: 'Data'; }
            #tabela-os td:nth-child(6):before { content: 'Status'; }
            #tabela-os td:nth-child(7):before { content: 'A√ß√µes'; }
            
            #tabela-historico td:nth-child(1):before { content: 'N√∫mero'; }
            #tabela-historico td:nth-child(2):before { content: 'Solicitante'; }
            #tabela-historico td:nth-child(3):before { content: 'Setor'; }
            #tabela-historico td:nth-child(4):before { content: 'Equipamento'; }
            #tabela-historico td:nth-child(5):before { content: 'Data'; }
            #tabela-historico td:nth-child(6):before { content: 'Status'; }
            #tabela-historico td:nth-child(7):before { content: 'A√ß√µes'; }
        }
        /* Impress√£o */
        .print-only {
            display: none;
        }
        @media print {
            body > *:not(.print-only):not(.container) {
                display: none !important;
            }
            .print-only {
                display: block !important;
                page-break-after: always;
            }
            html, body {
                background: #fff !important;
            }
        }

        /* Estilo para gr√°ficos mais compactos e elegantes */
        .chart-card {
            background: #fff;
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 200px;
        }
        .chart-card h3 {
            margin: 0;
            color: #00843d;
            font-size: 1.02em;
        }
        .chart-card canvas {
            width: 100% !important;
            height: 180px !important;
            max-height: 260px;
        }

        /* Mini-charts por t√©cnico */
        .mini-charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
            align-items: stretch;
        }
        .mini-chart-card {
            width: 170px;
            background: #fff;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.04);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .mini-chart-card canvas { height: 110px !important; width: 100% !important; }
        .mini-chart-card .mini-label { font-size: 0.92em; margin-top: 6px; color: #222; font-weight: 600; }
        .mini-chart-card .mini-sub { font-size: 0.8em; color: #666; margin-top: 2px; }

        /* Ajustes responsivos */
        @media (max-width: 900px) {
            .chart-card { min-height: 180px; padding: 12px; }
            .chart-card canvas { height: 160px !important; }
            .mini-chart-card { width: calc(50% - 12px); }
        }
        @media (max-width: 520px) {
            .mini-chart-card { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="login-container" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#222;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;">
        <form id="loginForm" style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;box-shadow:0 2px 16px #0003;min-width:320px;max-width:90vw;display:flex;flex-direction:column;gap:18px;">
            <h2 style="color:#00843d;text-align:center;margin-bottom:8px;">Login</h2>
            <input type="text" id="login-nome" placeholder="Nome" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
            <div style="display:flex;align-items:center;gap:8px;">
                <input type="password" id="login-senha" placeholder="Senha" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;flex:1;">
                <button type="button" id="toggle-login-senha" tabindex="-1" style="background:none;border:none;cursor:pointer;font-size:1.2em;">üëÅÔ∏è</button>
            </div>
            <input type="tel" id="login-telefone" placeholder="Telefone" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
            <button type="submit" style="background:#39ff14;color:#111;font-weight:bold;font-size:1.1em;padding:12px 0;border:none;border-radius:6px;cursor:pointer;">Entrar</button>
            <div id="login-erro" style="color:#d00;text-align:center;display:none;"></div>
        </form>
    </div>
    <div class="main-layout" style="display:none;" id="app-main-layout">
        <nav class="sidebar">
            <div class="sidebar-header">
                ambipar <span class="subtitle">environment</span>
                <button id="btn-logout" style="position:absolute;right:18px;top:18px;background:#d00;color:#fff;border:none;border-radius:6px;padding:7px 18px;font-weight:bold;cursor:pointer;font-size:1em;z-index:20;">Sair</button>
            </div>
            <div class="sidebar-menu">
                <button class="sidebar-btn active" data-tab="dashboard">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    Painel
                </button>
                <button class="sidebar-btn" data-tab="solicitantes">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    Solicitantes
                </button>
                <button class="sidebar-btn" data-tab="tecnicos">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M10.05 16.05c-.73.73-1.15 1.15-1.8 2.2.71.14 1.46.22 2.25.22.79 0 1.54-.08 2.25-.22-.65-1.05-1.08-1.47-1.8-2.2-.47-.48-.84-.84-1.2-1.2-.36.36-.73.72-1.2 1.2z"/></svg>
                    T√©cnicos
                </button>
                <button class="sidebar-btn" data-tab="nova-os">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Nova OS
                </button>
                <button class="sidebar-btn" data-tab="gerenciar-os">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-6v2h14V7H7z"/></svg>
                    Gerenciar OS
                </button>
                <button class="sidebar-btn" data-tab="historico-os">
                    <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 1 0 8.95 10.11h-2.02A7 7 0 1 1 12 5v4l3.89-3.89L12 2v4a9 9 0 0 0 1 17.93V21a7 7 0 1 1 7-7h2a9 9 0 0 0-9-9z"/></svg>
                    Hist√≥rico
                </button>
                <button class="sidebar-btn" data-tab="maquinas">
                    <svg viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 0-2 2v1.07A7.001 7.001 0 0 0 5.07 10H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h1.07A7.001 7.001 0 0 0 10 20.93V22a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-1.07A7.001 7.001 0 0 0 18.93 14H20a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-1.07A7.001 7.001 0 0 0 14 5.07V4a2 2 0 0 0-2-2h-0z"/></svg>
                    M√°quinas
                </button>
                <button class="sidebar-btn" data-tab="pecas">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8v-6H3v6zm0 8h8v-6H3v6zm10-8h8V5h-8v8zm0 8h8v-6h-8v6z"/></svg>
                    Pe√ßas
                </button>
                <button class="sidebar-btn" data-tab="preventivas">
                    <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4l-1.5-1.5L12 11 10.5 9.5 9 11zM3 5h6v2H3V5zm0 4h4v2H3V9zM3 13h8v2H3v-2z"/></svg>
                    Preventivas
                </button>
                <button class="sidebar-btn" data-tab="relatorios">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
                    Relat√≥rios
                </button>
            </div>
        </nav>
        <div class="container">
            <!-- Painel Dashboard -->
            <div id="dashboard" class="tabcontent active">
                <div class="os-card">
                    <h2>Painel de Controle</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #39ff14;">
                            <h3 style="margin-top: 0; color: #00843d;">OS Pendentes</h3>
                            <p style="font-size: 2em; font-weight: bold;" id="count-pendentes">0</p>
                        </div>
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #f90;">
                            <h3 style="margin-top: 0; color: #f90;">OS em Andamento</h3>
                            <p style="font-size: 2em; font-weight: bold;" id="count-andamento">0</p>
                        </div>
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #00843d;">
                            <h3 style="margin-top: 0; color: #00843d;">OS Conclu√≠das</h3>
                            <p style="font-size: 2em; font-weight: bold;" id="count-concluidas">0</p>
                        </div>
                    </div>
                    
                    <h3>OS Urgentes</h3>
                    <div id="os-urgentes" style="margin-bottom: 30px;"></div>
                    
                    <h3>Pr√≥ximos Vencimentos</h3>
                    <div id="proximos-vencimentos"></div>
                </div>
            </div>
            
            <!-- Cadastro de Solicitantes -->
            <div id="solicitantes" class="tabcontent">
                <div class="os-card">
                    <h2>Cadastrar Solicitante</h2>
                    <form id="solicitanteForm">
                        <div class="form-group">
                            <label for="solicitante-nome">Nome:</label>
                            <input type="text" id="solicitante-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="solicitante-setor">Setor:</label>
                            <select id="solicitante-setor" required>
                                <option value="">Selecione um setor</option>
                                <option value="Produ√ß√£o">Produ√ß√£o</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="Qualidade">Qualidade</option>
                                <option value="Log√≠stica">Log√≠stica</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="solicitante-contato">Contato:</label>
                            <input type="tel" id="solicitante-contato" required>
                        </div>
                        <button type="submit">Salvar Solicitante</button>
                    </form>
                </div>
                
                <div class="os-card">
                    <h3>Solicitantes Cadastrados</h3>
                    <table id="tabela-solicitantes">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Setor</th>
                                <th>Contato</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Cadastro de T√©cnicos -->
            <div id="tecnicos" class="tabcontent">
                <div class="os-card">
                    <h2>Cadastrar T√©cnico</h2>
                    <form id="tecnicoForm">
                        <div class="form-group">
                            <label for="tecnico-nome">Nome:</label>
                            <input type="text" id="tecnico-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="tecnico-especialidade">Especialidade:</label>
                            <select id="tecnico-especialidade" required>
                                <option value="">Selecione</option>
                                <option value="Eletricista">Eletricista</option>
                                <option value="Mec√¢nico">Mec√¢nico</option>
                                <option value="Eletr√¥nico">Eletr√¥nico</option>
                                <option value="Inform√°tica">Inform√°tica</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tecnico-contato">Contato:</label>
                            <input type="tel" id="tecnico-contato" required>
                        </div>
                        <button type="submit">Salvar T√©cnico</button>
                    </form>
                </div>
                
                <div class="os-card">
                    <h3>T√©cnicos Cadastrados</h3>
                    <table id="tabela-tecnicos">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Especialidade</th>
                                <th>Contato</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Nova Ordem de Servi√ßo -->
            <div id="nova-os" class="tabcontent">
                <div class="os-card">
                    <h2>Nova Ordem de Servi√ßo</h2>
                    <form id="osForm">
                        <div class="form-group">
                            <label for="os-solicitante">Solicitante:</label>
                            <select id="os-solicitante" required>
                                <option value="">Selecione um solicitante</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-setor">Setor:</label>
                            <select id="os-setor" required>
                                <option value="">Selecione um setor</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="Dubom canos">Dubom canos</option>
                                <option value="Braspol Gr√£os">Braspol Gr√£os</option>
                                <option value="Braspol inje√ß√£o">Braspol inje√ß√£o</option>
                                <option value="Adiministrativo">Adiministrativo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-maquina">M√°quina:</label>
                            <select id="os-maquina" required>
                                <option value="">Selecione uma m√°quina</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-serial">N√∫mero de Patrim√¥nio:</label>
                            <input type="text" id="os-serial" readonly>
                        </div>
                        <div class="form-group">
                            <label for="os-tecnico">T√©cnico Respons√°vel:</label>
                            <select id="os-tecnico" required>
                                <option value="">Selecione um t√©cnico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-data">Data de Abertura:</label>
                            <input type="date" id="os-data" required>
                        </div>
                        <div class="form-group">
                            <label for="os-prazo">Prazo para Conclus√£o:</label>
                            <input type="date" id="os-prazo">
                        </div>
                        <div class="form-group">
                            <label for="os-problema">Problema Relatado:</label>
                            <textarea id="os-problema" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="os-diagnostico">Diagn√≥stico T√©cnico:</label>
                            <textarea id="os-diagnostico" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="os-solucao">Solu√ß√£o Aplicada:</label>
                            <textarea id="os-solucao" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="os-status">Status:</label>
                            <select id="os-status" required>
                                <option value="pendente">Pendente</option>
                                <option value="andamento">Em Andamento</option>
                                <option value="concluida">Conclu√≠da</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                        <button type="submit">Salvar OS</button>
                    </form>
                </div>
            </div>
            
            <!-- Gerenciar OS -->
            <div id="gerenciar-os" class="tabcontent">
                <div class="os-card">
                    <h2>Gerenciar Ordens de Servi√ßo</h2>
                    <div style="margin-bottom: 20px;">
                        <label for="filtro-status">Filtrar por Status:</label>
                        <select id="filtro-status">
                            <option value="">Todos</option>
                            <option value="pendente">Pendentes</option>
                            <option value="andamento">Em Andamento</option>
                            <option value="concluida">Conclu√≠das</option>
                            <option value="cancelada">Canceladas</option>
                        </select>
                        <label for="filtro-tecnico" style="margin-left: 15px;">Filtrar por T√©cnico:</label>
                        <select id="filtro-tecnico">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <table id="tabela-os">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Solicitante</th>
                                <th>Setor</th>
                                <th>Equipamento</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Hist√≥rico de OS -->
            <div id="historico-os" class="tabcontent">
                <div class="os-card">
                    <h2>Hist√≥rico de Ordens de Servi√ßo</h2>
                    <div style="margin-bottom: 20px;">
                        <label for="historico-setor">Filtrar por Setor:</label>
                        <select id="historico-setor">
                            <option value="">Todos</option>
                            <option value="Produ√ß√£o">Produ√ß√£o</option>
                            <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                            <option value="Qualidade">Qualidade</option>
                            <option value="Log√≠stica">Log√≠stica</option>
                            <option value="Administrativo">Administrativo</option>
                            <option value="Outros">Outros</option>
                        </select>
                        <label for="historico-periodo" style="margin-left: 15px;">Per√≠odo:</label>
                        <select id="historico-periodo">
                            <option value="30">√öltimos 30 dias</option>
                            <option value="90">√öltimos 90 dias</option>
                            <option value="365">√öltimos 12 meses</option>
                            <option value="0">Todo o per√≠odo</option>
                        </select>
                    </div>
                    <table id="tabela-historico">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Solicitante</th>
                                <th>Setor</th>
                                <th>Equipamento</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div style="margin-top: 20px;">
                        <button onclick="exportarHistoricoExcel()">Exportar para Excel</button>
                        <button onclick="imprimirHistorico()" style="margin-left: 10px;">Imprimir Relat√≥rio</button>
                    </div>
                </div>
            </div>
            
            <!-- M√°quinas -->
            <div id="maquinas" class="tabcontent">
                <div class="os-card">
                    <h2>Cadastro de M√°quinas</h2>
                    <form id="maquinaForm">
                        <div class="form-group">
                            <label for="maquina-nome">Nome:</label>
                            <input type="text" id="maquina-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="maquina-patrimonio">Patrim√¥nio:</label>
                            <input type="text" id="maquina-patrimonio">
                        </div>
                        <div class="form-group">
                            <label for="maquina-setor">Setor:</label>
                            <select id="maquina-setor" required>
                                <option value="">Selecione um setor</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="Dubom canos">Dubom canos</option>
                                <option value="Braspol Gr√£os">Braspol Gr√£os</option>
                                <option value="Braspol inje√ß√£o">Braspol inje√ß√£o</option>
                                <option value="Adiministrativo">Adiministrativo</option>
                            </select>
                        </div>

                        <!-- Pe√ßas utilizadas pela m√°quina (lista din√¢mica) -->
                        <div class="form-group">
                            <label for="maquina-peca-input">Pe√ßas (adicione uma a uma):</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="text" id="maquina-peca-input" placeholder="Nome da pe√ßa">
                                <button type="button" id="btn-add-peca" class="btn-action" style="padding:8px 10px;">Adicionar</button>
                            </div>
                            <ul id="maquina-pecas-list" style="margin:8px 0 0 0;padding-left:18px;"></ul>
                        </div>

                        <!-- Itens de preventiva (lista din√¢mica) -->
                        <div class="form-group">
                            <label for="maquina-preventiva-input">Itens de Preventiva (adicione um a um):</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="text" id="maquina-preventiva-input" placeholder="Item para verificar">
                                <button type="button" id="btn-add-preventiva" class="btn-action" style="padding:8px 10px;">Adicionar</button>
                            </div>
                            <ul id="maquina-preventiva-list" style="margin:8px 0 0 0;padding-left:18px;"></ul>
                        </div>

                        <button type="submit">Salvar M√°quina</button>
                    </form>
                </div>
                <div class="os-card">
                    <h3>M√°quinas Cadastradas</h3>
                    <table id="tabela-maquinas">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Patrim√¥nio</th>
                                <th>Setor</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Pe√ßas -->
            <div id="pecas" class="tabcontent">
                <div class="os-card">
                    <h2>Pe√ßas das M√°quinas</h2>
                    <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <label for="pecas-filtro-maquina">M√°quina:</label>
                        <select id="pecas-filtro-maquina"><option value="">Todas</option></select>
                        <label for="pecas-filtro-setor" style="margin-left:8px;">Setor:</label>
                        <select id="pecas-filtro-setor"><option value="">Todos</option></select>
                        <input id="pecas-busca" placeholder="Buscar pe√ßa" style="padding:6px;margin-left:8px;min-width:180px;">
                        <button id="pecas-refresh" class="btn-action" style="margin-left:auto;padding:6px 10px;">Atualizar</button>
                    </div>
                    <table id="tabela-pecas">
                        <thead><tr><th>M√°quina</th><th>Setor</th><th>Pe√ßa</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Preventivas -->
            <div id="preventivas" class="tabcontent">
                <div class="os-card">
                    <h2>Preventivas</h2>
                    <div style="margin-bottom:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
                        <label for="preventivas-setor">Filtrar por Setor:</label>
                        <select id="preventivas-setor">
                            <option value="">Todos</option>
                        </select>
                        <label style="margin-left:12px;display:flex;align-items:center;gap:6px;"><input type="checkbox" id="preventivas-pendentes-only"> Mostrar apenas pendentes</label>
                        <input id="preventivas-busca" placeholder="Buscar m√°quina ou patrim√¥nio" style="padding:6px;margin-left:8px;min-width:180px;">
                    </div>
                    <div id="preventivas-list"></div>
                </div>
            </div>

            <!-- Relat√≥rios -->
            <div id="relatorios" class="tabcontent">
                <div class="os-card">
                    <h2>Relat√≥rios</h2>
                    <div style="display: grid; gap: 12px;">
                        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                            <label for="relatorio-periodo">Per√≠odo:</label>
                            <select id="relatorio-periodo">
                                <option value="semanal">Semanal (√∫ltimos 7 dias)</option>
                                <option value="mensal" selected>Mensal (√∫ltimos 30 dias)</option>
                                <option value="anual">Anual (√∫ltimos 365 dias)</option>
                                <option value="personalizado">Personalizado</option>
                            </select>

                            <label id="label-relatorio-inicio" for="relatorio-inicio" style="display:none;">In√≠cio:</label>
                            <input type="date" id="relatorio-inicio" style="display:none;">

                            <label id="label-relatorio-fim" for="relatorio-fim" style="display:none;">Fim:</label>
                            <input type="date" id="relatorio-fim" style="display:none;">

                            <button id="btn-gerar-relatorio">Gerar Relat√≥rio</button>
                            <button id="btn-exportar-relatorio" disabled>Exportar CSV</button>
                            <button id="btn-imprimir-relatorio" disabled>Imprimir</button>
                            <button id="btn-abrir-relatorio-nova-janela" disabled>Visualizar em Nova Janela</button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                            <div class="chart-card" style="padding:12px;">
                                <h3 style="margin-top: 0; color: #00843d;">OS por Status</h3>
                                <canvas id="chart-status" height="160"></canvas>
                            </div>
                            <div class="chart-card" style="padding:12px;">
                                <h3 style="margin-top: 0; color: #00843d;">OS por T√©cnico</h3>
                                <canvas id="chart-tecnicos" height="160"></canvas>
                            </div>
                            <div class="chart-card" style="padding:12px;">
                                <h3 style="margin-top: 0; color: #00843d;">OS por Setor</h3>
                                <canvas id="chart-setores" height="160"></canvas>
                            </div>
                            <div class="chart-card" style="padding:12px;">
                                <h3 style="margin-top: 0; color: #00843d;">OS por M√°quina (top 10)</h3>
                                <canvas id="chart-maquinas" height="160"></canvas>
                            </div>
                        </div>

                        <div id="mini-charts-per-tecnico" class="mini-charts-container" style="margin-top:10px;"></div>

                        <div style="margin-top:12px; background:#fff; border-radius:10px; padding:12px; box-shadow: 0 1px 6px rgba(0,0,0,0.05);">
                            <h3 style="margin-top:0;color:#00843d;">Resumo por T√©cnico</h3>
                            <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                <button id="btn-exportar-tecnicos" disabled>Exportar T√©cnicos CSV</button>
                            </div>
                            <table id="tabela-tecnicos-resumo">
                                <thead>
                                    <tr>
                                        <th>T√©cnico</th>
                                        <th>Pendentes</th>
                                        <th>Conclu√≠das</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div style="margin-top: 12px; background:#fff; border-radius:10px; padding:12px; box-shadow: 0 1px 6px rgba(0,0,0,0.05);">
                            <div id="relatorio-summary"></div>
                            <table id="tabela-relatorio">
                                <thead>
                                    <tr>
                                        <th>N√∫mero</th>
                                        <th>Solicitante</th>
                                        <th>Setor</th>
                                        <th>Equipamento</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>T√©cnico</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualiza√ß√£o/impress√£o de OS -->
    <div id="modal-os" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
        <div style="background: white; max-width: 800px; margin: 30px auto; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);">
            <div id="os-print-content">
                <!-- Conte√∫do da OS ser√° inserido aqui -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="imprimirOS()" style="padding: 10px 20px; background: #39ff14; color: #111; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">Imprimir OS</button>
                <button onclick="fecharModalOS()" style="padding: 10px 20px; background: #d00; color: white; border: none; border-radius: 5px; margin-left: 15px; font-weight: bold; cursor: pointer;">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Firebase App (core) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firestore Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
    // Fun√ß√£o de login simples
    let usuarioLogado = null;
    function mostrarApp() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-main-layout').style.display = 'flex';
    }
    function esconderApp() {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('app-main-layout').style.display = 'none';
    }
    document.addEventListener('DOMContentLoaded', function() {
        esconderApp();
        const loginForm = document.getElementById('loginForm');
        // Bot√£o de logout
        setTimeout(() => {
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.onclick = function() {
                    usuarioLogado = null;
                    esconderApp();
                    // Limpa campos do login
                    document.getElementById('login-nome').value = '';
                    document.getElementById('login-senha').value = '';
                    document.getElementById('login-telefone').value = '';
                };
            }
        }, 400);
        // Visualizar senha login
        setTimeout(() => {
            const btnToggle = document.getElementById('toggle-login-senha');
            if (btnToggle) {
                btnToggle.onclick = function() {
                    const senhaInput = document.getElementById('login-senha');
                    if (senhaInput.type === 'password') {
                        senhaInput.type = 'text';
                        this.textContent = 'üôà';
                    } else {
                        senhaInput.type = 'password';
                        this.textContent = 'üëÅÔ∏è';
                    }
                };
            }
        }, 200);
        // Defina aqui o usu√°rio administrador (altere conforme desejar)
        const ADMIN_NOME = 'Danielson';
        const ADMIN_SENHA = 'Dani8564';
        const ADMIN_TELEFONE = '88996116544'; // coloque seu telefone

        // Exibe o formul√°rio de cadastro de usu√°rio (apenas para admin)
        function mostrarCadastroUsuario() {
            let modal = document.getElementById('modal-cadastro-usuario');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-cadastro-usuario';
                modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;';
                modal.innerHTML = `
                <form id="form-cadastro-usuario" style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;box-shadow:0 2px 16px #0003;min-width:320px;max-width:90vw;display:flex;flex-direction:column;gap:18px;">
                    <h2 style="color:#00843d;text-align:center;margin-bottom:8px;">Cadastrar Novo Usu√°rio</h2>
                    <input type="text" id="novo-nome" placeholder="Nome" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                    <input type="password" id="novo-senha" placeholder="Senha" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                    <input type="tel" id="novo-telefone" placeholder="Telefone" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                    <select id="novo-tipo" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                        <option value="">Selecione o tipo</option>
                        <option value="manutencao">Manuten√ß√£o</option>
                        <option value="producao">Produ√ß√£o</option>
                    </select>
                    <button type="submit" style="background:#39ff14;color:#111;font-weight:bold;font-size:1.1em;padding:12px 0;border:none;border-radius:6px;cursor:pointer;">Cadastrar</button>
                    <button type="button" id="fechar-cadastro-usuario" style="background:#d00;color:#fff;font-weight:bold;font-size:1.1em;padding:12px 0;border:none;border-radius:6px;cursor:pointer;margin-top:8px;">Fechar</button>
                    <div id="cadastro-usuario-erro" style="color:#d00;text-align:center;display:none;"></div>
                </form>`;
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'flex';
            }
            document.getElementById('fechar-cadastro-usuario').onclick = function() {
                modal.style.display = 'none';
            };
            document.getElementById('form-cadastro-usuario').onsubmit = function(e) {
                e.preventDefault();
                // Normaliza√ß√£o igual ao login
                let nome = document.getElementById('novo-nome').value.trim().toLowerCase().replace(/\s+/g, ' ');
                let senha = document.getElementById('novo-senha').value.trim();
                let telefone = document.getElementById('novo-telefone').value.replace(/\D/g, '');
                const tipo = document.getElementById('novo-tipo').value;
                const erroDiv = document.getElementById('cadastro-usuario-erro');
                erroDiv.style.display = 'none';
                if (!nome || !senha || !telefone || !tipo) {
                    erroDiv.textContent = 'Preencha todos os campos.';
                    erroDiv.style.display = 'block';
                    return;
                }
                // Verifica se j√° existe (normalizado)
                db.collection('usuarios').where('nome','==',nome).where('telefone','==',telefone).get().then(snapshot => {
                    if (!snapshot.empty) {
                        erroDiv.textContent = 'Usu√°rio j√° existe.';
                        erroDiv.style.display = 'block';
                        return;
                    }
                    db.collection('usuarios').add({nome,senha,telefone,tipo, criadoEm: new Date().toISOString()}).then(() => {
                        alert('Usu√°rio cadastrado com sucesso!');
                        modal.style.display = 'none';
                    });
                });
            };
        }

        loginForm.onsubmit = function(e) {
            e.preventDefault();
            const nome = document.getElementById('login-nome').value.trim();
            const senha = document.getElementById('login-senha').value.trim();
            const telefone = document.getElementById('login-telefone').value.trim();
            const erroDiv = document.getElementById('login-erro');
            erroDiv.style.display = 'none';
            if (!nome || !senha || !telefone) {
                erroDiv.textContent = 'Preencha todos os campos.';
                erroDiv.style.display = 'block';
                return;
            }
            // ADMIN login
            if (nome === ADMIN_NOME && senha === ADMIN_SENHA && telefone === ADMIN_TELEFONE) {
                usuarioLogado = {id: 'admin', nome: ADMIN_NOME, telefone: ADMIN_TELEFONE, admin: true};
                mostrarApp();
                registrarAcesso(usuarioLogado);
                // Adiciona bot√£o de cadastro de usu√°rio no menu (se n√£o existir)
                setTimeout(() => {
                    if (!document.getElementById('btn-cadastrar-usuario')) {
                        const nav = document.querySelector('.sidebar-menu');
                        const btn = document.createElement('button');
                        btn.id = 'btn-cadastrar-usuario';
                        btn.className = 'sidebar-btn';
                        btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:22px;height:22px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Cadastrar Usu√°rio';
                        btn.onclick = mostrarCadastroUsuario;
                        nav.appendChild(btn);
                    }
                    // Bot√£o para ver usu√°rios cadastrados (apenas admin)
                    if (!document.getElementById('btn-listar-usuarios')) {
                        const nav = document.querySelector('.sidebar-menu');
                        const btn = document.createElement('button');
                        btn.id = 'btn-listar-usuarios';
                        btn.className = 'sidebar-btn';
                        btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:22px;height:22px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05C15.64 13.36 17 14.28 17 15.5V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg> Usu√°rios Cadastrados';
                        btn.onclick = mostrarListaUsuarios;
                        nav.appendChild(btn);
                    }
                }, 500);
                return;
            }
        // Fun√ß√£o para mostrar lista de usu√°rios cadastrados (apenas admin)
        function mostrarListaUsuarios() {
            // Cria modal
            let modal = document.getElementById('modal-lista-usuarios');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-lista-usuarios';
                modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center;';
                modal.innerHTML = `
                    <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;box-shadow:0 2px 16px #0003;min-width:320px;max-width:95vw;max-height:90vh;overflow:auto;display:flex;flex-direction:column;gap:18px;">
                        <h2 style="color:#00843d;text-align:center;margin-bottom:8px;">Usu√°rios Cadastrados</h2>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead><tr><th>Nome</th><th>Telefone</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="usuarios-lista-tbody"></tbody>
                        </table>
                        <button type="button" id="fechar-lista-usuarios" style="background:#d00;color:#fff;font-weight:bold;font-size:1.1em;padding:12px 0;border:none;border-radius:6px;cursor:pointer;margin-top:8px;">Fechar</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'flex';
            }
            document.getElementById('fechar-lista-usuarios').onclick = function() {
                modal.style.display = 'none';
            };
            // Busca usu√°rios do Firestore
            db.collection('usuarios').get().then(snapshot => {
                const tbody = document.getElementById('usuarios-lista-tbody');
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const tr = document.createElement('tr');
                    // Bot√µes de a√ß√£o (editar e apagar, n√£o permite apagar admin)
                    let btnDelete = '';
                    let btnEdit = '';
                    if (user.nome !== ADMIN_NOME || user.telefone !== ADMIN_TELEFONE) {
                        btnDelete = `<button class='btn-delete' style='padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;background:#d00;color:#fff;margin-left:4px;' data-id='${doc.id}'>Apagar</button>`;
                        btnEdit = `<button class='btn-edit' style='padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;background:#00843d;color:#fff;' data-id='${doc.id}' data-nome='${user.nome}' data-telefone='${user.telefone}' data-tipo='${user.tipo || ''}' data-senha='${user.senha || ''}'>Editar</button>`;
                    } else {
                        btnDelete = `<span style='color:#888;font-size:0.95em;'>Admin</span>`;
                    }
                    tr.innerHTML = `<td>${user.nome}</td><td>${user.telefone}</td><td>${btnEdit}${btnDelete}</td>`;
                    tbody.appendChild(tr);
                });
                // Adiciona evento aos bot√µes de apagar
                tbody.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.onclick = function() {
                        if (confirm('Tem certeza que deseja apagar este usu√°rio?')) {
                            const userId = this.getAttribute('data-id');
                            db.collection('usuarios').doc(userId).delete().then(() => {
                                this.closest('tr').remove();
                            }).catch(err => {
                                alert('Erro ao apagar usu√°rio: ' + err.message);
                            });
                        }
                    };
                });
                // Adiciona evento aos bot√µes de editar
                tbody.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.onclick = function() {
                        const userId = this.getAttribute('data-id');
                        const nomeAtual = this.getAttribute('data-nome');
                        const telefoneAtual = this.getAttribute('data-telefone');
                        const tipoAtual = this.getAttribute('data-tipo') || '';
                        const senhaAtual = this.getAttribute('data-senha') || '';
                        // Cria modal de edi√ß√£o
                        let modalEdit = document.getElementById('modal-editar-usuario');
                        if (!modalEdit) {
                            modalEdit = document.createElement('div');
                            modalEdit.id = 'modal-editar-usuario';
                            modalEdit.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;';
                            modalEdit.innerHTML = `
                                <form id="form-editar-usuario" style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;box-shadow:0 2px 16px #0003;min-width:320px;max-width:90vw;display:flex;flex-direction:column;gap:18px;">
                                    <h2 style=\"color:#00843d;text-align:center;margin-bottom:8px;\">Editar Usu√°rio</h2>
                                    <input type="text" id="edit-nome" placeholder="Nome" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                                    <input type="tel" id="edit-telefone" placeholder="Telefone" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                                    <select id="edit-tipo" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;">
                                        <option value="">Selecione o tipo</option>
                                        <option value="manutencao">Manuten√ß√£o</option>
                                        <option value="producao">Produ√ß√£o</option>
                                    </select>
                                    <div style='display:flex;align-items:center;gap:8px;'>
                                        <input type="password" id="edit-senha" placeholder="Senha" required style="padding:10px;font-size:1em;border-radius:5px;border:1px solid #ccc;flex:1;">
                                        <button type="button" id="toggle-senha" tabindex="-1" style="background:none;border:none;cursor:pointer;font-size:1.2em;">üëÅÔ∏è</button>
                                    </div>
                                    <button type="submit" style="background:#39ff14;color:#111;font-weight:bold;font-size:1.1em;padding:12px 0;border:none;border-radius:6px;cursor:pointer;">Salvar Altera√ß√µes</button>
                                    <button type="button" id="fechar-editar-usuario" style="background:#d00;color:#fff;font-weight:bold;font-size:1.1em;padding:12px 0;border:none;border-radius:6px;cursor:pointer;margin-top:8px;">Fechar</button>
                                    <div id="editar-usuario-erro" style="color:#d00;text-align:center;display:none;"></div>
                                </form>`;
                            document.body.appendChild(modalEdit);
                        } else {
                            modalEdit.style.display = 'flex';
                        }
                        // Preenche campos
                        document.getElementById('edit-nome').value = nomeAtual;
                        document.getElementById('edit-telefone').value = telefoneAtual;
                        document.getElementById('edit-tipo').value = tipoAtual;
                        document.getElementById('edit-senha').value = senhaAtual;
                        // Mostrar/ocultar senha
                        document.getElementById('toggle-senha').onclick = function() {
                            const senhaInput = document.getElementById('edit-senha');
                            if (senhaInput.type === 'password') {
                                senhaInput.type = 'text';
                                this.textContent = 'üôà';
                            } else {
                                senhaInput.type = 'password';
                                this.textContent = 'üëÅÔ∏è';
                            }
                        };
                        // Fechar modal
                        document.getElementById('fechar-editar-usuario').onclick = function() {
                            modalEdit.style.display = 'none';
                        };
                        // Submeter edi√ß√£o
                        document.getElementById('form-editar-usuario').onsubmit = function(e) {
                            e.preventDefault();
                            const novoNome = document.getElementById('edit-nome').value.trim();
                            const novoTelefone = document.getElementById('edit-telefone').value.trim();
                            const novoTipo = document.getElementById('edit-tipo').value;
                            const novaSenha = document.getElementById('edit-senha').value;
                            const erroDiv = document.getElementById('editar-usuario-erro');
                            erroDiv.style.display = 'none';
                            if (!novoNome || !novoTelefone || !novoTipo || !novaSenha) {
                                erroDiv.textContent = 'Preencha todos os campos.';
                                erroDiv.style.display = 'block';
                                return;
                            }
                            // Atualiza no Firestore
                            db.collection('usuarios').doc(userId).update({nome: novoNome, telefone: novoTelefone, tipo: novoTipo, senha: novaSenha}).then(() => {
                                alert('Usu√°rio atualizado com sucesso!');
                                modalEdit.style.display = 'none';
                                mostrarListaUsuarios();
                            }).catch(err => {
                                erroDiv.textContent = 'Erro ao atualizar usu√°rio: ' + err.message;
                                erroDiv.style.display = 'block';
                            });
                        };
                    };
                });
            });
        }
            // Busca usu√°rio no Firestore (apenas login, sem auto-registro)
            db.collection('usuarios').where('nome','==',nome).where('telefone','==',telefone).get().then(snapshot => {
                if (snapshot.empty) {
                    erroDiv.textContent = 'Usu√°rio n√£o encontrado. Solicite cadastro ao administrador.';
                    erroDiv.style.display = 'block';
                    return;
                }
                let achou = false;
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.senha === senha) {
                        usuarioLogado = {id: doc.id, nome: user.nome, telefone: user.telefone, admin: false};
                        achou = true;
                        registrarAcesso(usuarioLogado);
                        mostrarApp();
                    }
                });
                if (!achou) {
                    erroDiv.textContent = 'Senha incorreta.';
                    erroDiv.style.display = 'block';
                }
            }).catch(() => {
                erroDiv.textContent = 'Erro ao acessar o banco de dados.';
                erroDiv.style.display = 'block';
            });
        };
        function registrarAcesso(usuario) {
            db.collection('acessos').add({usuarioId: usuario.id, nome: usuario.nome, telefone: usuario.telefone, dataHora: new Date().toISOString()});
        }
    });
        // Configura√ß√£o do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD4FH7GjivSwsnhqCGvYdYd6AYpLrulGRQ",
  authDomain: "ordens-servico-37369.firebaseapp.com",
  projectId: "ordens-servico-37369",
  storageBucket: "ordens-servico-37369.firebasestorage.app",
  messagingSenderId: "956106820939",
  appId: "1:956106820939:web:fb5df0102c23c506036cce",
  measurementId: "G-15FMG1E6BM"
};

// Inicializa o Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

        // Banco de dados local
        let solicitantes = JSON.parse(localStorage.getItem('solicitantes')) || [];
        let tecnicos = JSON.parse(localStorage.getItem('tecnicos')) || [];
        let maquinas = JSON.parse(localStorage.getItem('maquinas')) || [];
        let ordensServico = JSON.parse(localStorage.getItem('ordensServico')) || [];
        let ultimoNumeroOS = parseInt(localStorage.getItem('ultimoNumeroOS')) || 0;

        // Inicializa√ß√£o do sistema
document.addEventListener('DOMContentLoaded', function() {
    // Fun√ß√£o para carregar solicitantes do Firestore
    function carregarSolicitantesFirestore(callback) {
        db.collection('solicitantes').get().then(snapshot => {
            solicitantes = [];
            snapshot.forEach(doc => {
                let s = doc.data();
                s.id = s.id || doc.id;
                solicitantes.push(s);
            });
            if (callback) callback();
        });
    }
    // Fun√ß√£o para carregar t√©cnicos do Firestore
    function carregarTecnicosFirestore(callback) {
        db.collection('tecnicos').get().then(snapshot => {
            tecnicos = [];
            snapshot.forEach(doc => {
                let t = doc.data();
                t.id = t.id || doc.id;
                tecnicos.push(t);
            });
            if (callback) callback();
        });
    }

    function carregarMaquinasFirestore(callback) {
        db.collection('maquinas').get().then(snapshot => {
            maquinas = [];
            snapshot.forEach(doc => {
                let m = doc.data();
                m.id = m.id || doc.id;
                maquinas.push(m);
            });
            localStorage.setItem('maquinas', JSON.stringify(maquinas));
            if (callback) callback();
        }).catch(err => {
            console.warn('N√£o foi poss√≠vel carregar m√°quinas do Firestore:', err);
            if (callback) callback();
        });
    }

    // Carrega dados do Firestore e s√≥ depois inicializa interface
    carregarSolicitantesFirestore(function() {
        carregarTecnicosFirestore(function() {
            // Configura navega√ß√£o entre abas
            const sidebarBtns = document.querySelectorAll('.sidebar-btn');
            const tabContents = document.querySelectorAll('.tabcontent');
            sidebarBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    sidebarBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(tab => tab.classList.remove('active'));
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tab = document.getElementById(tabId);
                    if (tab) tab.classList.add('active');
                    // Atualiza dados espec√≠ficos da aba quando aberta
                    if (tabId === 'dashboard') atualizarDashboard();
                    if (tabId === 'solicitantes') {
                        carregarSolicitantesFirestore(function() {
                            atualizarTabelaSolicitantes();
                            atualizarSelectSolicitantes();
                        });
                    }
                    if (tabId === 'tecnicos') {
                        carregarTecnicosFirestore(function() {
                            atualizarTabelaTecnicos();
                            atualizarSelectTecnicos();
                            atualizarSelectFiltroTecnicos();
                        });
                    }
                    if (tabId === 'gerenciar-os') {
                        db.collection('ordensServico').orderBy('numero', 'desc').get().then(snapshot => {
                            ordensServico = [];
                            snapshot.forEach(doc => {
                                let os = doc.data();
                                os.id = doc.id;
                                ordensServico.push(os);
                            });
                            atualizarTabelaOS();
                        });
                    }
                    if (tabId === 'historico-os') atualizarTabelaHistorico();
                    if (tabId === 'pecas') {
                        // Atualiza lista de m√°quinas antes de exibir pe√ßas (quando poss√≠vel)
                        if (typeof db !== 'undefined') {
                            carregarMaquinasFirestore(function() { atualizarSelectMaquinas(); atualizarTabPecas(); });
                        } else { atualizarSelectMaquinas(); atualizarTabPecas(); }
                    }
                    if (tabId === 'preventivas') { atualizarSelectPreventivasSetor(); renderPreventivas(); }
                    if (tabId === 'relatorios') {
                        atualizarRelatorios();
                        setTimeout(function() {
                            try { if (chartStatusObj) chartStatusObj.resize(); if (chartTecnicosObj) chartTecnicosObj.resize(); if (chartSetoresObj) chartSetoresObj.resize(); if (chartMaquinasObj) chartMaquinasObj.resize(); if (chartPorTecnicoObjs && chartPorTecnicoObjs.length) chartPorTecnicoObjs.forEach(c=>c.resize()); } catch(e) {}
                        }, 300);
                    }
                });
            });
            // Garante que a primeira aba esteja ativa ao carregar
            const btnAtivo = document.querySelector('.sidebar-btn.active');
            if (btnAtivo) {
                const tabId = btnAtivo.getAttribute('data-tab');
                const tab = document.getElementById(tabId);
                if (tab) tab.classList.add('active');
            }
            // Inicializa selects
            atualizarSelectSolicitantes();
            atualizarSelectTecnicos();
            atualizarSelectFiltroTecnicos();
            // Configura formul√°rios
            configurarFormularios();

            // Inicializa filtros e listeners da aba Preventivas
            atualizarSelectPreventivasSetor();
            const selPrev = document.getElementById('preventivas-setor');
            const chkPrev = document.getElementById('preventivas-pendentes-only');
            const buscaPrev = document.getElementById('preventivas-busca');
            if (selPrev) selPrev.addEventListener('change', renderPreventivas);
            if (chkPrev) chkPrev.addEventListener('change', renderPreventivas);
            if (buscaPrev) buscaPrev.addEventListener('input', renderPreventivas);

            // Atualiza dashboard
            atualizarDashboard();
            // Atualiza tabelas
            atualizarTabelaSolicitantes();
            atualizarTabelaTecnicos();
            atualizarTabelaOS();
            atualizarTabelaHistorico();
            configurarRelatorios();
            // Configura data atual no formul√°rio de OS
            document.getElementById('os-data').valueAsDate = new Date();
        });
    });
});

        // Fun√ß√µes para atualizar selects
        function atualizarSelectSolicitantes() {
            const select = document.getElementById('os-solicitante');
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecione um solicitante</option>';
            solicitantes.forEach(solicitante => {
                const option = document.createElement('option');
                option.value = solicitante.id;
                option.textContent = `${solicitante.nome} - ${solicitante.setor}`;
                select.appendChild(option);
            });
        }
        
        function atualizarSelectTecnicos() {
            const select = document.getElementById('os-tecnico');
            if (!select) return;
            
            select.innerHTML = '<option value="">Selecione um t√©cnico</option>';
            tecnicos.forEach(tecnico => {
                const option = document.createElement('option');
                option.value = tecnico.id;
                option.textContent = `${tecnico.nome} (${tecnico.especialidade})`;
                select.appendChild(option);
            });
        }
        
        function atualizarSelectMaquinas() {
            const select = document.getElementById('os-maquina');
            if (!select) return;

            const previousValue = select.value || '';
            select.innerHTML = '<option value="">Selecione uma m√°quina</option>';
            maquinas.forEach(maquina => {
                const option = document.createElement('option');
                option.value = maquina.id;
                option.textContent = `${maquina.nome} ${maquina.patrimonio ? '- ' + maquina.patrimonio : ''} (${maquina.setor})`;
                select.appendChild(option);
            });

            // Restaura sele√ß√£o anterior se poss√≠vel e atualiza patrim√¥nio autom√°ticamente
            if (previousValue) {
                select.value = previousValue;
            }

            // Se houver uma m√°quina selecionada, atualiza o campo de patrim√¥nio
            const selectedId = select.value;
            const serialInput = document.getElementById('os-serial');
            if (selectedId && serialInput) {
                const maquina = maquinas.find(m => m.id === selectedId);
                serialInput.value = maquina ? (maquina.patrimonio || '') : '';
            } else if (serialInput) {
                // se n√£o estiver selecionado, limpa o campo de patrim√¥nio
                serialInput.value = '';
            }

            // Dispara evento change para garantir que listeners reajam
            select.dispatchEvent(new Event('change'));
        }

        function atualizarTabelaMaquinas() {
            const tbody = document.querySelector('#tabela-maquinas tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            maquinas.forEach(maquina => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${maquina.nome}</td>
                    <td>${maquina.patrimonio || ''}</td>
                    <td>${maquina.setor}</td>
                    <td>
                        <button class="btn-action btn-view" data-id="${maquina.id}">Ver</button>
                        <button class="btn-action btn-edit" data-id="${maquina.id}">Editar</button>
                        <button class="btn-action btn-delete" data-id="${maquina.id}">Remover</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Eventos
            document.querySelectorAll('#tabela-maquinas .btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    visualizarMaquina(this.getAttribute('data-id'));
                });
            });
            document.querySelectorAll('#tabela-maquinas .btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    editarMaquina(this.getAttribute('data-id'));
                });
            });
            document.querySelectorAll('#tabela-maquinas .btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('Tem certeza que deseja remover esta m√°quina?')) {
                        maquinas = maquinas.filter(m => m.id !== id);
                        localStorage.setItem('maquinas', JSON.stringify(maquinas));
                        // tenta apagar do firestore tamb√©m
                        if (typeof db !== 'undefined') {
                            db.collection('maquinas').doc(id).delete().catch(()=>{});
                        }
                        atualizarTabelaMaquinas();
                        atualizarSelectMaquinas();
                        // Atualiza tamb√©m a aba Preventivas
                        if (typeof atualizarSelectPreventivasSetor === 'function') atualizarSelectPreventivasSetor();
                        if (typeof renderPreventivas === 'function') renderPreventivas();
                    }
                });
            });
        }

        function editarMaquina(maquinaId) {
            const maquina = maquinas.find(m => m.id === maquinaId);
            if (!maquina) return;

            const novoNome = prompt('Nome:', maquina.nome);
            if (novoNome === null) return;
            const novoPatrimonio = prompt('Patrim√¥nio:', maquina.patrimonio || '');
            if (novoPatrimonio === null) return;
            const novoSetor = prompt('Setor:', maquina.setor || '');
            if (novoSetor === null) return;

            // Permite editar listas como CSV (apenas se o usu√°rio quiser)
            const pecasStr = prompt('Pe√ßas (separe por v√≠rgula):', (maquina.pecas || []).join(', '));
            if (pecasStr !== null) maquina.pecas = pecasStr.split(',').map(s=>s.trim()).filter(Boolean);
            const prevStr = prompt('Itens de preventiva (separe por v√≠rgula):', (maquina.preventiva || []).join(', '));
            if (prevStr !== null) maquina.preventiva = prevStr.split(',').map(s=>s.trim()).filter(Boolean);

            maquina.nome = novoNome.trim();
            maquina.patrimonio = novoPatrimonio.trim();
            maquina.setor = novoSetor.trim();

            localStorage.setItem('maquinas', JSON.stringify(maquinas));
            // atualiza no firestore se poss√≠vel
            if (typeof db !== 'undefined') {
                db.collection('maquinas').doc(maquina.id).set(Object.assign({}, maquina)).catch(()=>{});
            }

            atualizarTabelaMaquinas();
            atualizarSelectMaquinas();
        }
        
        function atualizarSelectFiltroTecnicos() {
            const select = document.getElementById('filtro-tecnico');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos</option>';
            tecnicos.forEach(tecnico => {
                const option = document.createElement('option');
                option.value = tecnico.id;
                option.textContent = tecnico.nome;
                select.appendChild(option);
            });
        }

        // Visualiza detalhes de m√°quina (pe√ßas / preventiva)
        function visualizarMaquina(maquinaId) {
            const maquina = maquinas.find(m => m.id === maquinaId);
            if (!maquina) return;
            let modal = document.getElementById('modal-visualizar-maquina');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-visualizar-maquina';
                modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2500;display:flex;align-items:center;justify-content:center;';
                modal.innerHTML = `
                    <div style="background:#fff;padding:24px;border-radius:10px;max-width:720px;width:95%;box-shadow:0 2px 16px rgba(0,0,0,0.2);">
                        <h2 style="color:#00843d;margin-top:0;">Detalhes da M√°quina</h2>
                        <div id="modal-maquina-content"></div>
                        <div style="text-align:right;margin-top:12px;"><button id="fechar-visualizar-maquina" style="background:#d00;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer;font-weight:bold;">Fechar</button></div>
                    </div>`;
                document.body.appendChild(modal);
                document.getElementById('fechar-visualizar-maquina').onclick = function() { modal.style.display = 'none'; };
            } else {
                modal.style.display = 'flex';
            }
            const content = document.getElementById('modal-maquina-content');
            const pecasHtml = (maquina.pecas && maquina.pecas.length) ? `<ul>${maquina.pecas.map(p => '<li>'+p+'</li>').join('')}</ul>` : '<p>Nenhuma pe√ßa cadastrada.</p>';
            const prevHtml = (maquina.preventiva && maquina.preventiva.length) ? `<ul>${maquina.preventiva.map(p => '<li>'+p+'</li>').join('')}</ul>` : '<p>Nenhum item de preventiva cadastrado.</p>';
            content.innerHTML = `
                <p><strong>Nome:</strong> ${maquina.nome}</p>
                <p><strong>Patrim√¥nio:</strong> ${maquina.patrimonio || '‚Äî'}</p>
                <p><strong>Setor:</strong> ${maquina.setor || '‚Äî'}</p>
                <h3 style="color:#00843d;margin-bottom:6px;">Pe√ßas</h3>
                ${pecasHtml}
                <h3 style="color:#00843d;margin-bottom:6px;">Itens de Preventiva</h3>
                ${prevHtml}
            `;
        }

        // Fun√ß√µes para a aba Preventivas
        function atualizarSelectPreventivasSetor() {
            const select = document.getElementById('preventivas-setor');
            if (!select) return;
            select.innerHTML = '<option value="">Todos</option>';
            const setores = Array.from(new Set(maquinas.map(m => m.setor).filter(s => s && s.toString().trim() !== ''))).sort();
            setores.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                select.appendChild(option);
            });
        }

        function renderPreventivas() {
            const container = document.getElementById('preventivas-list');
            if (!container) return;
            const setorFilter = document.getElementById('preventivas-setor') ? document.getElementById('preventivas-setor').value : '';
            const pendentesOnly = document.getElementById('preventivas-pendentes-only') ? document.getElementById('preventivas-pendentes-only').checked : false;
            const busca = document.getElementById('preventivas-busca') ? document.getElementById('preventivas-busca').value.toLowerCase() : '';
            container.innerHTML = '';

            const maquinasFiltradas = maquinas.filter(m => {
                if (setorFilter && m.setor !== setorFilter) return false;
                if (busca && !( (m.nome||'').toLowerCase().includes(busca) || (m.patrimonio||'').toLowerCase().includes(busca) )) return false;
                if (pendentesOnly) {
                    const hasPending = (m.preventiva || []).some((item, idx) => {
                        const st = m.preventivaStatus && typeof m.preventivaStatus[idx] !== 'undefined' ? m.preventivaStatus[idx] : false;
                        return !st;
                    });
                    if (!hasPending) return false;
                }
                return true;
            });

            if (maquinasFiltradas.length === 0) { container.innerHTML = '<p>Nenhuma m√°quina encontrada.</p>'; return; }

            maquinasFiltradas.forEach(m => {
                const bloco = document.createElement('div');
                bloco.style = 'background:#fff;border-radius:8px;padding:12px;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,0.04);';
                const header = document.createElement('div');
                header.innerHTML = `<strong>${m.nome}</strong> <span style="color:#666;margin-left:8px">${m.patrimonio || ''}${m.setor ? ' - ' + m.setor : ''}</span> <button class="btn-action btn-open-preventiva" data-id="${m.id}" style="margin-left:12px;padding:6px 10px;">Visualizar</button>`;
                bloco.appendChild(header);
                // Resumo compacto (n√£o exibe os itens)
                const total = (m.preventiva || []).length;
                const pendentes = (m.preventiva || []).reduce((acc, itm, idx) => { const st = m.preventivaStatus && typeof m.preventivaStatus[idx] !== 'undefined' ? m.preventivaStatus[idx] : false; return acc + (st ? 0 : 1); }, 0);
                const last = m.preventivaDatetime || '';
                const assin = m.preventivaAssinatura || '';
                const info = document.createElement('div');
                info.style = 'color:#666;margin-top:8px;display:flex;flex-direction:column;gap:6px;';
                info.innerHTML = `<div><strong>Itens:</strong> ${total} (Pendentes: ${pendentes})</div><div><strong>√öltima preventiva:</strong> ${last ? last : '‚Äî'}</div><div><strong>Assinatura:</strong> ${assin ? assin : '‚Äî'}</div>`;
                bloco.appendChild(info);
                container.appendChild(bloco);
            });

            // (itens n√£o exibidos aqui; marca√ß√µes feitas na visualiza√ß√£o detalhada)

            // listeners para bot√£o 'Visualizar' que abre nova janela
            container.querySelectorAll('.btn-open-preventiva').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    abrirPreventivaNovaJanela(id);
                });
            });
        }

        // Aba Pe√ßas: renderiza pe√ßas das m√°quinas com filtros e visualiza√ß√£o
        function atualizarTabPecas() {
            const container = document.getElementById('pecas');
            if (!container) return;
            const selMaquina = document.getElementById('pecas-filtro-maquina');
            const selSetor = document.getElementById('pecas-filtro-setor');
            const buscaEl = document.getElementById('pecas-busca');
            const busca = buscaEl ? buscaEl.value.trim().toLowerCase() : '';

            // Preenche selects
            if (selMaquina) {
                const prev = selMaquina.value || '';
                selMaquina.innerHTML = '<option value="">Todas</option>';
                maquinas.forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.id; opt.textContent = m.nome + (m.patrimonio ? ' - ' + m.patrimonio : '') + (m.setor ? ' ('+m.setor+')' : ''); selMaquina.appendChild(opt);
                });
                if (prev) selMaquina.value = prev;
                if (!selMaquina.dataset._pecasListener) { selMaquina.addEventListener('change', atualizarTabPecas); selMaquina.dataset._pecasListener = '1'; }
            }
            if (selSetor) {
                const prevs = selSetor.value || '';
                selSetor.innerHTML = '<option value="">Todos</option>';
                const setores = Array.from(new Set(maquinas.map(m => m.setor).filter(s => s && s.toString().trim() !== ''))).sort();
                setores.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; selSetor.appendChild(opt); });
                if (prevs) selSetor.value = prevs;
                if (!selSetor.dataset._pecasListener) { selSetor.addEventListener('change', atualizarTabPecas); selSetor.dataset._pecasListener = '1'; }
            }

            const tbody = document.querySelector('#tabela-pecas tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            let count = 0;
            maquinas.forEach(m => {
                if (selMaquina && selMaquina.value && m.id !== selMaquina.value) return;
                if (selSetor && selSetor.value && m.setor !== selSetor.value) return;
                (m.pecas || []).forEach((p, idx) => {
                    if (busca && p.toLowerCase().indexOf(busca) === -1) return;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${m.nome}</td><td>${m.setor || ''}</td><td>${p}</td><td><button class="btn-action btn-view-peca" data-id="${m.id}" data-idx="${idx}">Ver</button></td>`;
                    tbody.appendChild(tr);
                    count++;
                });
            });
            if (count === 0) tbody.innerHTML = '<tr><td colspan="4">Nenhuma pe√ßa encontrada.</td></tr>';

            // Events
            document.querySelectorAll('.btn-view-peca').forEach(btn => btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                visualizarMaquina(id);
            }));

            const buscaEl2 = document.getElementById('pecas-busca');
            if (buscaEl2 && !buscaEl2.dataset._pecasListener) { buscaEl2.addEventListener('input', atualizarTabPecas); buscaEl2.dataset._pecasListener = '1'; }
            const refresh = document.getElementById('pecas-refresh');
            if (refresh && !refresh.dataset._pecasListener) { refresh.addEventListener('click', atualizarTabPecas); refresh.dataset._pecasListener = '1'; }
        }

        // Garante que a aba pe√ßas seja atualizada quando a tabela de m√°quinas muda
        // (evita inconsist√™ncias quando adicionar/remover m√°quinas)
        if (typeof atualizarTabPecas === 'function') atualizarTabPecas();


        // Abre preventiva de uma m√°quina em nova janela (visualiza√ß√£o e impress√£o)
        function abrirPreventivaNovaJanela(maquinaId) {
            const maquina = maquinas.find(m => m.id === maquinaId);
            if (!maquina) return alert('M√°quina n√£o encontrada');

            const itens = maquina.preventiva || [];
            const statusObj = maquina.preventivaStatus || {};

            const itensHtml = itens.length === 0 ? '<p>Sem itens de preventiva cadastrados.</p>' : (`<ul style="padding-left:18px;">${itens.map((it, idx) => {
                const checked = statusObj[idx] ? 'checked' : '';
                return `<li><label><input type="checkbox" data-idx="${idx}" ${checked}> ${it}</label></li>`;
            }).join('')}</ul>`);

            // Data/hora em branco para preenchimento manual
            const datetimeHtml = `
                <div style="margin:10px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <label style="font-weight:600;margin-right:8px;">Data e Hora da Preventiva:</label>
                    <input type="datetime-local" id="preventiva-datetime" value="${maquina.preventivaDatetime || ''}" style="padding:6px;border:1px solid #ccc;border-radius:6px;">
                </div>
                <div style="margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <label style="font-weight:600;margin-right:8px;">Data e Hora da Conclus√£o:</label>
                    <input type="datetime-local" id="preventiva-datetime-conclusao" value="${maquina.preventivaConclusaoDatetime || ''}" style="padding:6px;border:1px solid #ccc;border-radius:6px;">
                </div>
                <div style="margin:8px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                    <label style="font-weight:600;margin-right:8px;">Hora In√≠cio:</label>
                    <input type="text" id="preventiva-hora-inicio" value="${maquina.preventivaHoraInicio || ''}" placeholder="     :     " style="padding:6px;border:none;border-bottom:1px solid #000;background:transparent;min-width:110px;text-align:left;">
                    <label style="font-weight:600;margin-left:12px;margin-right:8px;">Hora Fim:</label>
                    <input type="text" id="preventiva-hora-fim" value="${maquina.preventivaHoraFim || ''}" placeholder="     :     " style="padding:6px;border:none;border-bottom:1px solid #000;background:transparent;min-width:110px;text-align:left;">
                </div>
                <div style="margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    <label style="font-weight:600;margin-right:8px;">Assinatura (Nome):</label>
                    <input type="text" id="preventiva-assinatura" value="${maquina.preventivaAssinatura || ''}" placeholder="Assinatura" style="padding:6px;border:1px solid #ccc;border-radius:6px;min-width:200px;">
                </div>`;

            const html = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8"><title>Preventiva - ${maquina.nome}</title><style>body{font-family:Arial,sans-serif;margin:20px;background:#f6f6f6}header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px} .company{font-weight:bold;color:#39ff14;font-size:1.1em}h1{color:#00843d;margin:0} .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.06)}ul{margin-top:10px} .print-btn{display:inline-block;padding:8px 14px;background:#39ff14;color:#111;border-radius:6px;border:none;font-weight:bold;cursor:pointer;margin-bottom:12px}</style></head><body><header><div class="company">ambipar</div><div style="text-align:right"><h1>Preventiva</h1><div style="font-size:0.9em;color:#666">${maquina.nome}${maquina.patrimonio ? ' - ' + maquina.patrimonio : ''}${maquina.setor ? ' - ' + maquina.setor : ''}</div></div></header><div class="card"><p style="margin:0 0 8px 0"><strong>Patrim√¥nio:</strong> ${maquina.patrimonio || '‚Äî'}</p>${datetimeHtml}<button class="print-btn" onclick="window.print()">Imprimir Preventiva</button>${itensHtml}</div><script>
                (function(){
                    // Ao mudar um checkbox, sincroniza com a janela principal (se houver)
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.addEventListener('change', function() {
                            const idx = parseInt(this.getAttribute('data-idx'), 10);
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaStatus = m.preventivaStatus || {};
                                        m.preventivaStatus[idx] = this.checked;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    // Fallback: armazena no pr√≥prio localStorage da nova janela
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaStatus = m.preventivaStatus || {};
                                        m.preventivaStatus[idx] = this.checked;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    });

                    // Date/time input change: sincroniza com a janela principal para persist√™ncia
                    const dtInput = document.getElementById('preventiva-datetime');
                    if (dtInput) {
                        dtInput.addEventListener('change', function() {
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaDatetime = this.value || null;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaDatetime = this.value || null;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    }

                    // Data/hora de conclus√£o
                    const dtConclusao = document.getElementById('preventiva-datetime-conclusao');
                    if (dtConclusao) {
                        dtConclusao.addEventListener('change', function() {
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaConclusaoDatetime = this.value || null;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaConclusaoDatetime = this.value || null;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    }

                    // Hora in√≠cio
                    const hrInicio = document.getElementById('preventiva-hora-inicio');
                    if (hrInicio) {
                        hrInicio.addEventListener('change', function() {
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaHoraInicio = this.value || null;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaHoraInicio = this.value || null;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    }

                    // Hora fim
                    const hrFim = document.getElementById('preventiva-hora-fim');
                    if (hrFim) {
                        hrFim.addEventListener('change', function() {
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaHoraFim = this.value || null;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaHoraFim = this.value || null;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    }

                    // Assinatura
                    const sigInput = document.getElementById('preventiva-assinatura');
                    if (sigInput) {
                        sigInput.addEventListener('change', function() {
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaAssinatura = this.value ? this.value.trim() : null;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaAssinatura = this.value ? this.value.trim() : null;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    }

                    // Observa√ß√µes
                    const obsInput = document.getElementById('preventiva-observacao');
                    if (obsInput) {
                        obsInput.addEventListener('change', function() {
                            try {
                                if (window.opener && !window.opener.closed && window.opener.maquinas) {
                                    const m = window.opener.maquinas.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaObservacao = this.value ? this.value.trim() : null;
                                        window.opener.localStorage.setItem('maquinas', JSON.stringify(window.opener.maquinas));
                                        if (window.opener.renderPreventivas) window.opener.renderPreventivas();
                                        if (window.opener.db) window.opener.db.collection('maquinas').doc(m.id).set(Object.assign({}, m)).catch(()=>{});
                                    }
                                } else {
                                    const ms = JSON.parse(localStorage.getItem('maquinas') || '[]');
                                    const m = ms.find(x => x.id === '${maquinaId}');
                                    if (m) {
                                        m.preventivaObservacao = this.value ? this.value.trim() : null;
                                        localStorage.setItem('maquinas', JSON.stringify(ms));
                                    }
                                }
                            } catch (e) { console.error(e); }
                        });
                    }
                })();
            <\/script></body></html>`;

            const novaJanela = window.open('', '_blank');
            if (!novaJanela) { alert('N√£o foi poss√≠vel abrir a nova janela. Verifique o bloqueador de pop-ups.'); return; }
            novaJanela.document.write(html);
            novaJanela.document.close();
        }

        // Configura√ß√£o dos formul√°rios
        function configurarFormularios() {
            // Formul√°rio de solicitante
            const solicitanteForm = document.getElementById('solicitanteForm');
            if (solicitanteForm) {
                solicitanteForm.onsubmit = function(e) {
                    e.preventDefault();
                    const nome = document.getElementById('solicitante-nome').value.trim();
                    const setor = document.getElementById('solicitante-setor').value;
                    const contato = document.getElementById('solicitante-contato').value.trim();
                    if (!nome || !setor || !contato) {
                        alert('Preencha todos os campos obrigat√≥rios.');
                        return;
                    }
                    // Gera ID √∫nico
                    const id = Date.now().toString();
                    const novoSolicitante = { id, nome, setor, contato };
                    // Salva no Firestore
                    db.collection('solicitantes').add(novoSolicitante).then(() => {
                        // Recarrega do Firestore para garantir atualiza√ß√£o em todos os dispositivos
                        db.collection('solicitantes').get().then(snapshot => {
                            solicitantes = [];
                            snapshot.forEach(doc => {
                                let s = doc.data();
                                s.id = s.id || doc.id;
                                solicitantes.push(s);
                            });
                            atualizarTabelaSolicitantes();
                            atualizarSelectSolicitantes();
                            solicitanteForm.reset();
                            alert('Solicitante cadastrado com sucesso!');
                        });
                    }).catch((error) => {
                        alert('Erro ao salvar solicitante no banco de dados: ' + error.message);
                    });
                };
            }

            // Formul√°rio de t√©cnico
            const tecnicoForm = document.getElementById('tecnicoForm');
            if (tecnicoForm) {
                tecnicoForm.onsubmit = function(e) {
                    e.preventDefault();
                    const nome = document.getElementById('tecnico-nome').value.trim();
                    const especialidade = document.getElementById('tecnico-especialidade').value;
                    const contato = document.getElementById('tecnico-contato').value.trim();
                    if (!nome || !especialidade || !contato) {
                        alert('Preencha todos os campos obrigat√≥rios.');
                        return;
                    }
                    // Gera ID √∫nico
                    const id = Date.now().toString();
                    const novoTecnico = { id, nome, especialidade, contato };
                    // Salva no Firestore
                    db.collection('tecnicos').add(novoTecnico).then(() => {
                        // Recarrega do Firestore para garantir atualiza√ß√£o em todos os dispositivos
                        db.collection('tecnicos').get().then(snapshot => {
                            tecnicos = [];
                            snapshot.forEach(doc => {
                                let t = doc.data();
                                t.id = t.id || doc.id;
                                tecnicos.push(t);
                            });
                            atualizarTabelaTecnicos();
                            atualizarSelectTecnicos();
                            atualizarSelectFiltroTecnicos();
                            tecnicoForm.reset();
                            alert('T√©cnico cadastrado com sucesso!');
                        });
                    }).catch((error) => {
                        alert('Erro ao salvar t√©cnico no banco de dados: ' + error.message);
                    });
                };
            }

            // Formul√°rio de M√°quina
            const maquinaForm = document.getElementById('maquinaForm');
            if (maquinaForm) {
                // Elementos para listas
                const pecaInput = document.getElementById('maquina-peca-input');
                const btnAddPeca = document.getElementById('btn-add-peca');
                const pecasListEl = document.getElementById('maquina-pecas-list');
                const preventivaInput = document.getElementById('maquina-preventiva-input');
                const btnAddPreventiva = document.getElementById('btn-add-preventiva');
                const preventivaListEl = document.getElementById('maquina-preventiva-list');

                function createListItem(value) {
                    const li = document.createElement('li');
                    li.dataset.value = value;
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.style.marginBottom = '6px';
                    const span = document.createElement('span');
                    span.textContent = value;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn-action';
                    btn.textContent = 'Remover';
                    btn.style.marginLeft = '8px';
                    btn.addEventListener('click', function() { li.remove(); });
                    li.appendChild(span);
                    li.appendChild(btn);
                    return li;
                }

                if (btnAddPeca) btnAddPeca.addEventListener('click', function() {
                    const v = (pecaInput.value || '').trim();
                    if (!v) return;
                    pecasListEl.appendChild(createListItem(v));
                    pecaInput.value = '';
                });
                if (btnAddPreventiva) btnAddPreventiva.addEventListener('click', function() {
                    const v = (preventivaInput.value || '').trim();
                    if (!v) return;
                    preventivaListEl.appendChild(createListItem(v));
                    preventivaInput.value = '';
                });

                function clearMaquinaLists() {
                    pecasListEl.innerHTML = '';
                    preventivaListEl.innerHTML = '';
                }

                maquinaForm.onsubmit = function(e) {
                    e.preventDefault();
                    try {
                        const nome = document.getElementById('maquina-nome').value.trim();
                        const patrimonio = document.getElementById('maquina-patrimonio').value.trim();
                        const setor = document.getElementById('maquina-setor').value;
                        if (!nome || !setor) {
                            alert('Preencha todos os campos obrigat√≥rios.');
                            return;
                        }
                        const pecas = Array.from(pecasListEl.querySelectorAll('li')).map(li => li.dataset.value || li.textContent.trim());
                        const preventiva = Array.from(preventivaListEl.querySelectorAll('li')).map(li => li.dataset.value || li.textContent.trim());
                        const id = Date.now().toString();
                        const novaMaquina = { id, nome, patrimonio, setor, pecas, preventiva };

                        if (typeof db !== 'undefined') {
                            db.collection('maquinas').doc(id).set(novaMaquina).then(() => {
                                // Atualiza localmente e tenta recarregar do Firestore, se fun√ß√£o dispon√≠vel
                                maquinas.push(novaMaquina);
                                localStorage.setItem('maquinas', JSON.stringify(maquinas));
                                atualizarTabelaMaquinas();
                                atualizarSelectMaquinas();
                                maquinaForm.reset();
                                clearMaquinaLists();
                                alert('M√°quina cadastrada com sucesso!');
                                try {
                                    if (typeof carregarMaquinasFirestore === 'function') {
                                        carregarMaquinasFirestore(function() {
                                            atualizarTabelaMaquinas();
                                            atualizarSelectMaquinas();
                                        });
                                    }
                                } catch (err) { console.warn('carregarMaquinasFirestore n√£o est√° dispon√≠vel:', err); }
                            }).catch((error) => {
                                console.error('Erro ao salvar m√°quina no Firestore:', error);
                                // Fallback: salva localmente e atualiza UI
                                maquinas.push(novaMaquina);
                                localStorage.setItem('maquinas', JSON.stringify(maquinas));
                                atualizarTabelaMaquinas();
                                atualizarSelectMaquinas();
                                maquinaForm.reset();
                                clearMaquinaLists();
                                alert('M√°quina salva localmente devido a erro no banco (ver console para detalhes).');
                            });
                        } else {
                            // Firestore n√£o dispon√≠vel ‚Äî salva localmente
                            maquinas.push(novaMaquina);
                            localStorage.setItem('maquinas', JSON.stringify(maquinas));
                            atualizarTabelaMaquinas();
                            atualizarSelectMaquinas();
                            maquinaForm.reset();
                            clearMaquinaLists();
                            alert('M√°quina cadastrada com sucesso (salva localmente).');
                        }
                    } catch (err) {
                        console.error('Erro ao processar formul√°rio de m√°quina:', err);
                        alert('Ocorreu um erro ao processar o formul√°rio. Verifique o console para detalhes.');
                    }
                };
            }
            
            // Formul√°rio de OS
            const osForm = document.getElementById('osForm');
            if (osForm) {
                // Integra√ß√£o com sele√ß√£o de m√°quina
                const osMaquinaSelect = document.getElementById('os-maquina');
                if (osMaquinaSelect) {
                    // torna obrigat√≥rio e preenche patrim√¥nio ao selecionar
                    osMaquinaSelect.required = true;
                    osMaquinaSelect.addEventListener('change', function() {
                        const maquina = maquinas.find(m => m.id === this.value);
                        if (maquina) {
                            document.getElementById('os-serial').value = maquina.patrimonio || '';
                        } else {
                            document.getElementById('os-serial').value = '';
                        }
                    });
                }

                osForm.onsubmit = function(e) {
                    e.preventDefault();
                    const solicitanteId = document.getElementById('os-solicitante').value;
                    const setor = document.getElementById('os-setor').value;
                    const tecnicoId = document.getElementById('os-tecnico').value;
                    const maquinaId = document.getElementById('os-maquina') ? document.getElementById('os-maquina').value : '';
                    const maquinaObj = maquinas.find(m => m.id === maquinaId) || null;
                    const equipamento = maquinaObj ? maquinaObj.nome : '';
                    const serial = maquinaObj ? (maquinaObj.patrimonio || '') : document.getElementById('os-serial').value.trim();
                    const data = document.getElementById('os-data').value;
                    const prazo = document.getElementById('os-prazo').value;
                    const problema = document.getElementById('os-problema').value.trim();
                    const diagnostico = document.getElementById('os-diagnostico').value.trim();
                    const solucao = document.getElementById('os-solucao').value.trim();
                    const status = document.getElementById('os-status').value;
                    if (!solicitanteId || !setor || !maquinaId || !tecnicoId || !data || !problema) {
                        alert('Preencha todos os campos obrigat√≥rios.');
                        return;
                    }
                    // Incrementa n√∫mero da OS
                    ultimoNumeroOS++;
                    localStorage.setItem('ultimoNumeroOS', ultimoNumeroOS);
                    // Gera ID √∫nico
                    const id = Date.now().toString();

                    const osObj = {
                        id,
                        numero: ultimoNumeroOS,
                        solicitanteId,
                        setor,
                        equipamento,
                        serial,
                        tecnicoId,
                        maquinaId,
                        data,
                        prazo,
                        problema,
                        diagnostico,
                        solucao,
                        status,
                        dataConclusao: status === 'concluida' ? new Date().toISOString().split('T')[0] : null
                    };

                    if (typeof db !== 'undefined') {
                        db.collection('ordensServico').add(osObj).then((docRef) => {
                            // Atualiza localmente para refletir na UI imediatamente
                            ordensServico.push(osObj);
                            localStorage.setItem('ordensServico', JSON.stringify(ordensServico));
                            atualizarTabelaOS();
                            atualizarTabelaHistorico();
                            atualizarDashboard();
                            osForm.reset();
                            document.getElementById('os-data').valueAsDate = new Date();
                            alert(`Ordem de Servi√ßo #${ultimoNumeroOS} cadastrada com sucesso!`);
                            if (confirm('Deseja imprimir esta ordem de servi√ßo?')) {
                                abrirOSNovaPagina(id);
                            }
                        }).catch((error) => {
                            alert('Erro ao salvar OS no banco de dados: ' + error.message);
                        });
                    } else {
                        ordensServico.push(osObj);
                        localStorage.setItem('ordensServico', JSON.stringify(ordensServico));
                        atualizarTabelaOS();
                        atualizarTabelaHistorico();
                        atualizarDashboard();
                        osForm.reset();
                        document.getElementById('os-data').valueAsDate = new Date();
                        alert(`Ordem de Servi√ßo #${ultimoNumeroOS} cadastrada com sucesso!`);
                        if (confirm('Deseja imprimir esta ordem de servi√ßo?')) {
                            abrirOSNovaPagina(id);
                        }
                    }
                };
            }
            
            // Filtros da tabela OS
            document.getElementById('filtro-status').addEventListener('change', atualizarTabelaOS);
            document.getElementById('filtro-tecnico').addEventListener('change', atualizarTabelaOS);
            
            // Filtros do hist√≥rico
            document.getElementById('historico-setor').addEventListener('change', atualizarTabelaHistorico);
            document.getElementById('historico-periodo').addEventListener('change', atualizarTabelaHistorico);
        }

        // Fun√ß√µes para atualizar tabelas
        function atualizarTabelaSolicitantes() {
            const tbody = document.querySelector('#tabela-solicitantes tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            solicitantes.forEach(solicitante => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${solicitante.nome}</td>
                    <td>${solicitante.setor}</td>
                    <td>${solicitante.contato}</td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${solicitante.id}">Editar</button>
                        <button class="btn-action btn-delete" data-id="${solicitante.id}">Remover</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Configura eventos dos bot√µes
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const solicitanteId = this.getAttribute('data-id');
                    editarSolicitante(solicitanteId);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const solicitanteId = this.getAttribute('data-id');
                    if (confirm('Tem certeza que deseja remover este solicitante?')) {
                        solicitantes = solicitantes.filter(s => s.id !== solicitanteId);
                        localStorage.setItem('solicitantes', JSON.stringify(solicitantes));
                        atualizarTabelaSolicitantes();
                        atualizarSelectSolicitantes();
                    }
                });
            });
        }
        
        function atualizarTabelaTecnicos() {
            const tbody = document.querySelector('#tabela-tecnicos tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            tecnicos.forEach(tecnico => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${tecnico.nome}</td>
                    <td>${tecnico.especialidade}</td>
                    <td>${tecnico.contato}</td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${tecnico.id}">Editar</button>
                        <button class="btn-action btn-delete" data-id="${tecnico.id}">Remover</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Configura eventos dos bot√µes
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tecnicoId = this.getAttribute('data-id');
                    editarTecnico(tecnicoId);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tecnicoId = this.getAttribute('data-id');
                    if (confirm('Tem certeza que deseja remover este t√©cnico?')) {
                        tecnicos = tecnicos.filter(t => t.id !== tecnicoId);
                        localStorage.setItem('tecnicos', JSON.stringify(tecnicos));
                        atualizarTabelaTecnicos();
                        atualizarSelectTecnicos();
                        atualizarSelectFiltroTecnicos();
                    }
                });
            });
        }
        
        function atualizarTabelaOS() {
            const tbody = document.querySelector('#tabela-os tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const filtroStatus = document.getElementById('filtro-status').value;
            const filtroTecnico = document.getElementById('filtro-tecnico').value;

            // Busca OS do Firestore
            db.collection('ordensServico').orderBy('numero', 'desc').get().then(snapshot => {
                let osList = [];
                snapshot.forEach(doc => {
                    let os = doc.data();
                    os.id = doc.id;
                    osList.push(os);
                });

                // Filtra
                let osFiltradas = osList.filter(os => {
                    if (filtroStatus && os.status !== filtroStatus) return false;
                    if (filtroTecnico && os.tecnicoId !== filtroTecnico) return false;
                    return true;
                });

                osFiltradas.forEach(os => {
                    const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                    const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};

                    let statusClass = '';
                    if (os.status === 'pendente') statusClass = 'status-pendente';
                    else if (os.status === 'andamento') statusClass = 'status-andamento';
                    else if (os.status === 'concluida') statusClass = 'status-concluida';
                    else if (os.status === 'cancelada') statusClass = 'status-cancelada';

                    // Todos podem alterar status
                    let statusCell = `<select class="status-select" data-id="${os.id}">
                        <option value="pendente" ${os.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="andamento" ${os.status === 'andamento' ? 'selected' : ''}>Em Andamento</option>
                        <option value="concluida" ${os.status === 'concluida' ? 'selected' : ''}>Conclu√≠da</option>
                        <option value="cancelada" ${os.status === 'cancelada' ? 'selected' : ''}>Cancelada</option>
                    </select>`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${os.numero}</td>
                        <td>${solicitante.nome || 'Solicitante n√£o encontrado'}</td>
                        <td>${os.setor}</td>
                        <td>${os.equipamento}</td>
                        <td>${formatarData(os.data)}</td>
                        <td class="${statusClass}">${statusCell}</td>
                        <td>
                            <button class="btn-action btn-edit" data-id="${os.id}">Editar</button>
                            <button class="btn-action btn-view" data-id="${os.id}">Visualizar</button>
                            <button class="btn-action btn-delete" data-id="${os.id}" style="background:#d00;color:#fff;margin-left:4px;">Apagar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Configura eventos dos bot√µes
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const osId = this.getAttribute('data-id');
                        editarOS(osId);
                    });
                });
                document.querySelectorAll('.btn-view').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const osId = this.getAttribute('data-id');
                        abrirOSNovaPagina(osId);
                    });
                });
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const osId = this.getAttribute('data-id');
                        if (confirm('Tem certeza que deseja apagar esta Ordem de Servi√ßo?')) {
                            db.collection('ordensServico').doc(osId).delete().then(() => {
                                atualizarTabelaOS();
                                atualizarTabelaHistorico && atualizarTabelaHistorico();
                                atualizarDashboard && atualizarDashboard();
                            }).catch(err => {
                                alert('Erro ao apagar OS: ' + err.message);
                            });
                        }
                    });
                });

                // Todos podem alterar status
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', function() {
                        const osId = this.getAttribute('data-id');
                        const novaStatus = this.value;
                        // Atualiza status no Firestore
                        db.collection('ordensServico').doc(osId).update({
                            status: novaStatus,
                            dataConclusao: novaStatus === 'concluida' ? new Date().toISOString().split('T')[0] : null
                        }).then(() => {
                            atualizarTabelaOS();
                            atualizarTabelaHistorico();
                            atualizarDashboard();
                        });
                    });
                });
            });
        }
        
        function atualizarTabelaHistorico() {
            const tbody = document.querySelector('#tabela-historico tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const filtroSetor = document.getElementById('historico-setor').value;
            const periodo = parseInt(document.getElementById('historico-periodo').value);
            
            let hoje = new Date();
            let dataLimite = new Date();
            if (periodo > 0) {
                dataLimite.setDate(hoje.getDate() - periodo);
            }
            
            let osFiltradas = ordensServico.filter(os => {
                // Filtra por setor se selecionado
                if (filtroSetor && os.setor !== filtroSetor) return false;
                
                // Filtra por per√≠odo se selecionado
                if (periodo > 0) {
                    const dataOS = new Date(os.data);
                    return dataOS >= dataLimite;
                }
                
                return true;
            });
            
            // Ordena por data (mais recente primeiro)
            osFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            osFiltradas.forEach(os => {
                const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
                
                let statusClass = '';
                if (os.status === 'pendente') statusClass = 'status-pendente';
                else if (os.status === 'andamento') statusClass = 'status-andamento';
                else if (os.status === 'concluida') statusClass = 'status-concluida';
                else if (os.status === 'cancelada') statusClass = 'status-cancelada';
                
                const statusText = os.status === 'pendente' ? 'Pendente' :
                                  os.status === 'andamento' ? 'Em Andamento' :
                                  os.status === 'concluida' ? 'Conclu√≠da' : 'Cancelada';
                
                tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${os.numero}</td>
                    <td>${solicitante.nome || 'Solicitante n√£o encontrado'}</td>
                    <td>${os.setor}</td>
                    <td>${os.equipamento}</td>
                    <td>${formatarData(os.data)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <button class="btn-action btn-print" data-id="${os.id}">Imprimir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Configura eventos dos bot√µes
            document.querySelectorAll('.btn-print').forEach(btn => {
                btn.addEventListener('click', function() {
                    const osId = this.getAttribute('data-id');
                    visualizarOS(osId);
                });
            });
        }

        // Fun√ß√µes para edi√ß√£o de registros
        function editarSolicitante(solicitanteId) {
            const solicitante = solicitantes.find(s => s.id === solicitanteId);
            if (!solicitante) return;
            
            const novoNome = prompt('Nome:', solicitante.nome);
            if (novoNome === null) return;
            
            const novoSetor = prompt('Setor:', solicitante.setor);
            if (novoSetor === null) return;
            
            const novoContato = prompt('Contato:', solicitante.contato);
            if (novoContato === null) return;
            
            solicitante.nome = novoNome.trim();
            solicitante.setor = novoSetor.trim();
            solicitante.contato = novoContato.trim();
            
            localStorage.setItem('solicitantes', JSON.stringify(solicitantes));
            atualizarTabelaSolicitantes();
            atualizarSelectSolicitantes();
        }
        
        function editarTecnico(tecnicoId) {
            const tecnico = tecnicos.find(t => t.id === tecnicoId);
            if (!tecnico) return;
            
            const novoNome = prompt('Nome:', tecnico.nome);
            if (novoNome === null) return;
            
            const novaEspecialidade = prompt('Especialidade:', tecnico.especialidade);
            if (novaEspecialidade === null) return;
            
            const novoContato = prompt('Contato:', tecnico.contato);
            if (novoContato === null) return;
            
            tecnico.nome = novoNome.trim();
            tecnico.especialidade = novaEspecialidade.trim();
            tecnico.contato = novoContato.trim();
            
            localStorage.setItem('tecnicos', JSON.stringify(tecnicos));
            atualizarTabelaTecnicos();
            atualizarSelectTecnicos();
            atualizarSelectFiltroTecnicos();
        }
        
        function editarOS(osId) {
            const os = ordensServico.find(o => o.id === osId);
            if (!os) return;
            
            // Abre o formul√°rio de OS com os dados preenchidos
            document.querySelector('[data-tab="nova-os"]').click();
            
            // Preenche os campos do formul√°rio
            document.getElementById('os-solicitante').value = os.solicitanteId;
            document.getElementById('os-setor').value = os.setor;
            // Preenche m√°quina e patrim√¥nio (compat√≠vel com OS antigas)
            if (os.maquinaId && document.getElementById('os-maquina')) {
                document.getElementById('os-maquina').value = os.maquinaId || '';
                const maquina = maquinas.find(m => m.id === os.maquinaId);
                if (maquina) document.getElementById('os-serial').value = maquina.patrimonio || '';
                else document.getElementById('os-serial').value = os.serial || '';
            } else {
                // Se n√£o houver m√°quina associada (OS antiga), mostra patrim√¥nio salvo
                document.getElementById('os-serial').value = os.serial || '';
            }
            document.getElementById('os-tecnico').value = os.tecnicoId;
            document.getElementById('os-data').value = os.data;
            document.getElementById('os-prazo').value = os.prazo || '';
            document.getElementById('os-problema').value = os.problema;
            document.getElementById('os-diagnostico').value = os.diagnostico || '';
            document.getElementById('os-solucao').value = os.solucao || '';
            document.getElementById('os-status').value = os.status;
            
            // Remove a OS antiga
            ordensServico = ordensServico.filter(o => o.id !== osId);
            localStorage.setItem('ordensServico', JSON.stringify(ordensServico));
            
            alert('Edite os dados da OS e clique em "Salvar OS" para confirmar as altera√ß√µes.');
        }

        // Fun√ß√µes para o dashboard
        function atualizarDashboard() {
            // Contagem por status
            const pendentes = ordensServico.filter(os => os.status === 'pendente').length;
            const andamento = ordensServico.filter(os => os.status === 'andamento').length;
            const concluidas = ordensServico.filter(os => os.status === 'concluida').length;
            
            document.getElementById('count-pendentes').textContent = pendentes;
            document.getElementById('count-andamento').textContent = andamento;
            document.getElementById('count-concluidas').textContent = concluidas;
            
            // OS urgentes (pendentes ou em andamento com prazo vencido ou pr√≥ximo)
            const hoje = new Date();
            const osUrgentes = ordensServico.filter(os => {
                if (os.status !== 'pendente' && os.status !== 'andamento') return false;
                if (!os.prazo) return false;
                
                const prazo = new Date(os.prazo);
                const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                return diffDias <= 3; // Prazo vence em at√© 3 dias
            });
            
            const divUrgentes = document.getElementById('os-urgentes');
            divUrgentes.innerHTML = '';
            
            if (osUrgentes.length === 0) {
                divUrgentes.innerHTML = '<p>Nenhuma OS urgente no momento.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>N√∫mero</th>
                        <th>Solicitante</th>
                        <th>Setor</th>
                        <th>Equipamento</th>
                        <th>Prazo</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            osUrgentes.forEach(os => {
                const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                const prazo = new Date(os.prazo);
                const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                let statusClass = os.status === 'pendente' ? 'status-pendente' : 'status-andamento';
                let statusText = os.status === 'pendente' ? 'Pendente' : 'Em Andamento';
                
                let prazoText = formatarData(os.prazo);
                if (diffDias < 0) prazoText += ' (Vencido)';
                else if (diffDias === 0) prazoText += ' (Hoje)';
                else if (diffDias === 1) prazoText += ' (Amanh√£)';
                else prazoText += ` (Em ${diffDias} dias)`;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${os.numero}</td>
                    <td>${solicitante.nome || 'Solicitante n√£o encontrado'}</td>
                    <td>${os.setor}</td>
                    <td>${os.equipamento}</td>
                    <td>${prazoText}</td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
            
            divUrgentes.appendChild(table);
            
            // Pr√≥ximos vencimentos
            const divProximos = document.getElementById('proximos-vencimentos');
            divProximos.innerHTML = '';
            
            const osProximas = ordensServico.filter(os => {
                if (os.status !== 'pendente' && os.status !== 'andamento') return false;
                if (!os.prazo) return false;
                
                const prazo = new Date(os.prazo);
                const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                return diffDias > 3 && diffDias <= 7; // Prazo entre 4 e 7 dias
            });
            
            if (osProximas.length === 0) {
                divProximos.innerHTML = '<p>Nenhuma OS com vencimento pr√≥ximo.</p>';
                return;
            }
            
            const tableProximas = document.createElement('table');
            tableProximas.innerHTML = `
                <thead>
                    <tr>
                        <th>N√∫mero</th>
                        <th>Solicitante</th>
                        <th>Setor</th>
                        <th>Equipamento</th>
                        <th>Prazo</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbodyProximas = tableProximas.querySelector('tbody');
            
            osProximas.forEach(os => {
                const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                const prazo = new Date(os.prazo);
                const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
                
                let statusClass = os.status === 'pendente' ? 'status-pendente' : 'status-andamento';
                let statusText = os.status === 'pendente' ? 'Pendente' : 'Em Andamento';
                
                let prazoText = formatarData(os.prazo) + ` (Em ${diffDias} dias)`;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${os.numero}</td>
                    <td>${solicitante.nome || 'Solicitante n√£o encontrado'}</td>
                    <td>${os.setor}</td>
                    <td>${os.equipamento}</td>
                    <td>${prazoText}</td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                tbodyProximas.appendChild(tr);
            });
            
            divProximos.appendChild(tableProximas);
        }

        // Fun√ß√µes para visualiza√ß√£o e impress√£o de OS
        function visualizarOS(osId) {
            const os = ordensServico.find(o => o.id === osId);
            if (!os) return;
            const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
            const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
            let statusText = os.status === 'pendente' ? 'Pendente' :
                            os.status === 'andamento' ? 'Em Andamento' :
                            os.status === 'concluida' ? 'Conclu√≠da' : 'Cancelada';
            // Corrige exibi√ß√£o da data para n√£o subtrair um dia
            function formatarDataInput(dataString) {
                if (!dataString) return '';
                // N√£o criar objeto Date, apenas reformatar yyyy-mm-dd para dd/mm/yyyy
                const [ano, mes, dia] = dataString.split('-');
                return `${dia}/${mes}/${ano}`;
            }
            // Diagn√≥stico t√©cnico
            let diagnosticoHtml = '';
            if (os.diagnostico && os.diagnostico.trim() !== '') {
                diagnosticoHtml = `<p>${os.diagnostico.replace(/\n/g, '<br>')}</p>`;
            } else {
                diagnosticoHtml = `<p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p><p style="min-height:24px; border-bottom:1px solid #ccc;"></p>`;
            }
            // Solu√ß√£o aplicada
            let solucaoHtml = '';
            if (os.solucao && os.solucao.trim() !== '') {
                solucaoHtml = `<p>${os.solucao.replace(/\n/g, '<br>')}</p>`;
            } else {
                solucaoHtml = `<p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p><p style="min-height:24px; border-bottom:1px solid #ccc;"></p>`;
            }
            const html = `
                <style>
                    body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
                    .os-container {
                        max-width: 600px;
                        margin: 16px auto;
                        background: #fff;
                        border-radius: 8px;
                        box-shadow: 0 1px 6px #0001;
                        padding: 18px 22px 12px 22px;
                        font-size: 13px;
                    }
                    .os-header { text-align: center; margin-bottom: 12px; }
                    .os-header h1 { color: #00843d; margin-bottom: 2px; font-size: 1.2em; }
                    .os-header .subtitle { color: #666; font-size: 1em; }
                    .os-info { display: flex; gap: 10px; margin-bottom: 10px; }
                    .os-info-block { flex: 1; border: 1px solid #ddd; padding: 7px 10px; border-radius: 4px; }
                    .os-info-block h3 { margin: 0 0 4px 0; color: #00843d; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 2px; }
                    .os-details { margin-bottom: 8px; }
                    .os-details h3 { color: #00843d; font-size: 1em; margin: 0 0 2px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
                    .os-details p { white-space: pre-line; margin: 0 0 2px 0; }
                    .os-signatures { display: flex; gap: 20px; margin-top: 18px; }
                    .os-signature { border-top: 1px solid #000; padding-top: 6px; text-align: center; font-size: 0.95em; }
                    .print-button {
                        display: block;
                        margin: 16px auto 0 auto;
                        padding: 8px 18px;
                        background: #39ff14;
                        color: #111;
                        border: none;
                        border-radius: 5px;
                        font-weight: bold;
                        font-size: 1em;
                        cursor: pointer;
                    }
                    @media print {
                        body { background: #fff; }
                        .print-button { display: none; }
                        .os-container { box-shadow: none; margin: 0; }
                    }
                </style>
                
                <div class="os-header">
                    <h1>ORDEM DE SERVI√áO #${os.numero}</h1>
                    <div class="subtitle">${statusText} - ${formatarDataInput(os.data)}</div>
                </div>
                <div class="os-info">
                    <div class="os-info-block">
                        <h3>Solicitante</h3>
                        <p><strong>Nome:</strong> ${solicitante.nome || 'N√£o informado'}</p>
                        <p><strong>Setor:</strong> ${os.setor || 'N√£o informado'}</p>
                        <p><strong>Contato:</strong> ${solicitante.contato || 'N√£o informado'}</p>
                    </div>
                    <div class="os-info-block">
                        <h3>Servi√ßo</h3>
                        <p><strong>Equipamento:</strong> ${os.equipamento}</p>
                        <p><strong>Patrim√¥nio:</strong> ${os.serial || 'N√£o informado'}</p>
                        <p><strong>T√©cnico:</strong> ${tecnico.nome || 'N√£o informado'} (${tecnico.especialidade || 'N√£o informado'})</p>
                        <p><strong>Prazo:</strong> ${os.prazo ? formatarDataInput(os.prazo) : 'N√£o definido'}</p>
                    </div>
                </div>
                <div class="os-details">
                    <h3>Problema Relatado</h3>
                    <p>${os.problema}</p>
                </div>
                <div class="os-details">
                    <h3>Diagn√≥stico T√©cnico</h3>
                    ${diagnosticoHtml}
                </div>
                <div class="os-details">
                    <h3>Solu√ß√£o Aplicada</h3>
                    ${solucaoHtml}
                </div>
                <div class="os-details os-times">
                    <h3>Hor√°rio do Servi√ßo</h3>
                    ${ (os.servicos && os.servicos.length) ? os.servicos.map(s => `
                        <div style="margin-bottom:10px;">
                            <strong>${s}</strong>
                            <div style="margin-top:6px;">
                                <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px;"></span> <small>Hora In√≠cio</small>
                                <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px; margin-left:24px;"></span> <small>Hora T√©rmino</small>
                            </div>
                        </div>
                    `).join('') : `
                        <div style="margin-top:6px;">
                            <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px;"></span> <small>Hora In√≠cio</small>
                            <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px; margin-left:24px;"></span> <small>Hora T√©rmino</small>
                        </div>
                    ` }
                </div>
                <div class="os-signatures">
                    <div class="os-signature">
                        <p>______________________________</p>
                        <p>Assinatura do Solicitante</p>
                    </div>
                    <div class="os-signature">
                        <p>______________________________</p>
                        <p>Assinatura do T√©cnico</p>
                    </div>
                </div>
                <button class="print-button" onclick="window.print()">Imprimir OS</button>
            `;
            document.getElementById('os-print-content').innerHTML = html;
            document.getElementById('modal-os').style.display = 'block';
        }
        
        function fecharModalOS() {
            document.getElementById('modal-os').style.display = 'none';
        }
        
        function imprimirOS() {
            window.print();
        }

        // Fun√ß√µes para relat√≥rios
        function atualizarRelatorios() {
            // OS por status
            const statusCounts = {
                pendente: ordensServico.filter(os => os.status === 'pendente').length,
                andamento: ordensServico.filter(os => os.status === 'andamento').length,
                concluida: ordensServico.filter(os => os.status === 'concluida').length,
                cancelada: ordensServico.filter(os => os.status === 'cancelada').length
            };
            
            // OS por t√©cnico
            const tecnicoCounts = {};
            tecnicos.forEach(tecnico => {
                tecnicoCounts[tecnico.nome] = ordensServico.filter(os => os.tecnicoId === tecnico.id).length;
            });
            
            // OS por setor (din√¢mico a partir das OS cadastradas)
            const setores = Array.from(new Set(ordensServico.map(os => os.setor).filter(s => s && s.toString().trim() !== ''))).sort();
            const setorCounts = {};
            setores.forEach(setor => {
                setorCounts[setor] = ordensServico.filter(os => os.setor === setor).length;
            });
            
            // Cria gr√°ficos (simula√ß√£o - na pr√°tica voc√™ usaria uma biblioteca como Chart.js)
            document.getElementById('chart-status').innerHTML = '<p>Gr√°fico: OS por Status</p>';
            document.getElementById('chart-tecnicos').innerHTML = '<p>Gr√°fico: OS por T√©cnico</p>';
            document.getElementById('chart-setores').innerHTML = '<p>Gr√°fico: OS por Setor</p>';
            // Gera relat√≥rio padr√£o (mensal) quando a aba estiver dispon√≠vel
            if (document.getElementById('relatorio-periodo')) gerarRelatorio();
        }
        
        let relatorioAtual = [];
        let chartStatusObj = null;
        let chartTecnicosObj = null;
        let chartSetoresObj = null;
        let chartMaquinasObj = null;
        let chartPorTecnicoObjs = [];
        let chartJsLoading = false;
        let pendingChartCallbacks = [];

        function ensureChartJsLoaded(cb) {
            if (typeof Chart !== 'undefined') { if (cb) cb(); return; }
            if (cb) pendingChartCallbacks.push(cb);
            if (chartJsLoading) return;
            // Verifica se j√° existe uma tag script apontando para chart.js
            const existing = Array.from(document.querySelectorAll('script')).find(s => s.src && s.src.includes('chart.js'));
            if (existing) {
                chartJsLoading = true;
                existing.addEventListener('load', function() {
                    chartJsLoading = false;
                    pendingChartCallbacks.forEach(c => c());
                    pendingChartCallbacks = [];
                });
                existing.addEventListener('error', function() {
                    chartJsLoading = false;
                    console.error('Falha ao carregar Chart.js');
                    pendingChartCallbacks = [];
                });
                return;
            }

            chartJsLoading = true;
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            script.onload = function() {
                chartJsLoading = false;
                pendingChartCallbacks.forEach(c => c());
                pendingChartCallbacks = [];
            };
            script.onerror = function() {
                chartJsLoading = false;
                console.error('Falha ao carregar Chart.js');
                pendingChartCallbacks = [];
            };
            document.body.appendChild(script);
        }

        function configurarRelatorios() {
            const periodoSelect = document.getElementById('relatorio-periodo');
            const inicioInput = document.getElementById('relatorio-inicio');
            const fimInput = document.getElementById('relatorio-fim');
            const labelInicio = document.getElementById('label-relatorio-inicio');
            const labelFim = document.getElementById('label-relatorio-fim');
            const btnGerar = document.getElementById('btn-gerar-relatorio');
            const btnExport = document.getElementById('btn-exportar-relatorio');
            const btnPrint = document.getElementById('btn-imprimir-relatorio');

            if (periodoSelect) {
                periodoSelect.addEventListener('change', function() {
                    const personalizado = this.value === 'personalizado';
                    inicioInput.style.display = personalizado ? 'inline-block' : 'none';
                    fimInput.style.display = personalizado ? 'inline-block' : 'none';
                    labelInicio.style.display = personalizado ? 'inline-block' : 'none';
                    labelFim.style.display = personalizado ? 'inline-block' : 'none';
                });
            }

            if (btnGerar) btnGerar.addEventListener('click', function() { gerarRelatorio(); });
            if (btnExport) btnExport.addEventListener('click', exportarRelatorioCSV);
            if (btnPrint) btnPrint.addEventListener('click', imprimirRelatorio);
            const btnOpen = document.getElementById('btn-abrir-relatorio-nova-janela');
            if (btnOpen) btnOpen.addEventListener('click', abrirRelatorioNovaJanela);

            // Valores padr√£o
            if (document.getElementById('relatorio-fim')) document.getElementById('relatorio-fim').valueAsDate = new Date();
            const inicioDefault = new Date();
            inicioDefault.setDate(inicioDefault.getDate() - 30);
            if (document.getElementById('relatorio-inicio')) document.getElementById('relatorio-inicio').valueAsDate = inicioDefault;
        }

        function obterPeriodo(valor) {
            const hoje = new Date();
            let inicio = null;
            let fim = new Date();

            if (valor === 'semanal') {
                inicio = new Date();
                inicio.setDate(hoje.getDate() - 6);
            } else if (valor === 'mensal') {
                inicio = new Date();
                inicio.setDate(hoje.getDate() - 29);
            } else if (valor === 'anual') {
                inicio = new Date();
                inicio.setDate(hoje.getDate() - 364);
            } else if (valor === 'completo') {
                inicio = new Date(2000,0,1);
            } else if (valor === 'personalizado') {
                const s = document.getElementById('relatorio-inicio').value;
                const e = document.getElementById('relatorio-fim').value;
                if (!s || !e) return null;
                inicio = new Date(s);
                fim = new Date(e);
            } else {
                // padr√£o monthly
                inicio = new Date();
                inicio.setDate(hoje.getDate() - 29);
            }

            fim.setHours(23,59,59,999);
            return { inicio, fim };
        }

        function gerarRelatorio(periodoArg) {
            const periodoSelect = document.getElementById('relatorio-periodo');
            const periodo = periodoArg || (periodoSelect ? periodoSelect.value : 'mensal');
            const range = obterPeriodo(periodo);
            if (!range) {
                alert('Defina corretamente o per√≠odo personalizado.');
                return;
            }
            const { inicio, fim } = range;

            const resultados = ordensServico.filter(os => {
                const dataOS = new Date(os.data);
                return dataOS >= inicio && dataOS <= fim;
            });

            relatorioAtual = resultados;

            // Resumo
            const summary = document.getElementById('relatorio-summary');
            const total = resultados.length;
            const pend = resultados.filter(r => r.status === 'pendente').length;
            const and = resultados.filter(r => r.status === 'andamento').length;
            const conc = resultados.filter(r => r.status === 'concluida').length;
            const canc = resultados.filter(r => r.status === 'cancelada').length;

            summary.innerHTML = `<p><strong>Per√≠odo:</strong> ${formatarData(inicio.toISOString().split('T')[0])} - ${formatarData(fim.toISOString().split('T')[0])} &nbsp; <strong>Total OS:</strong> ${total} (P: ${pend} | A: ${and} | C: ${conc} | X: ${canc})</p>`;

            // Preenche tabela
            const tbody = document.querySelector('#tabela-relatorio tbody');
            tbody.innerHTML = '';

            resultados.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(os => {
                const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
                const statusText = os.status === 'pendente' ? 'Pendente' : os.status === 'andamento' ? 'Em Andamento' : os.status === 'concluida' ? 'Conclu√≠da' : 'Cancelada';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${os.numero}</td>
                    <td>${solicitante.nome || '‚Äî'}</td>
                    <td>${os.setor}</td>
                    <td>${os.equipamento}</td>
                    <td>${formatarData(os.data)}</td>
                    <td>${statusText}</td>
                    <td>${tecnico.nome || '‚Äî'}</td>
                `;
                tbody.appendChild(tr);
            });

            // Resumo por t√©cnico (apenas dados)
            try {
                const tabelaTec = document.querySelector('#tabela-tecnicos-resumo tbody');
                if (tabelaTec) {
                    tabelaTec.innerHTML = '';
                    if (tecnicos && tecnicos.length) {
                        const resumo = tecnicos.map(t => {
                            const pendentes = resultados.filter(r => r.tecnicoId === t.id && r.status === 'pendente').length;
                            const concluidas = resultados.filter(r => r.tecnicoId === t.id && r.status === 'concluida').length;
                            const totalTec = pendentes + concluidas;
                            return { nome: t.nome || '‚Äî', pendentes, concluidas, total: totalTec };
                        }).filter(r => r.pendentes > 0 || r.concluidas > 0 || r.total > 0);

                        if (resumo.length) {
                            resumo.sort((a,b) => b.total - a.total).forEach(r => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td>${r.nome}</td><td>${r.pendentes}</td><td>${r.concluidas}</td><td>${r.total}</td>`;
                                tabelaTec.appendChild(tr);
                            });
                            document.getElementById('btn-exportar-tecnicos').disabled = false;
                        } else {
                            tabelaTec.innerHTML = '<tr><td colspan="4">Nenhuma ordem por t√©cnico nesse per√≠odo.</td></tr>';
                            document.getElementById('btn-exportar-tecnicos').disabled = true;
                        }
                    } else {
                        tabelaTec.innerHTML = '<tr><td colspan="4">Nenhum t√©cnico cadastrado.</td></tr>';
                        document.getElementById('btn-exportar-tecnicos').disabled = true;
                    }
                }
            } catch (e) {
                console.warn('Erro ao gerar resumo por t√©cnico:', e);
                const tabelaTec = document.querySelector('#tabela-tecnicos-resumo tbody'); if (tabelaTec) tabelaTec.innerHTML = '<tr><td colspan="4">Erro ao gerar resumo.</td></tr>';
                try { document.getElementById('btn-exportar-tecnicos').disabled = true; } catch(e){}
            }

            // Habilita bot√µes
            document.getElementById('btn-exportar-relatorio').disabled = resultados.length === 0;
            document.getElementById('btn-imprimir-relatorio').disabled = resultados.length === 0;
            const btnOpen = document.getElementById('btn-abrir-relatorio-nova-janela'); if (btnOpen) btnOpen.disabled = resultados.length === 0;

            // Atualiza gr√°ficos (texto simples quando biblioteca n√£o estiver dispon√≠vel)
            atualizarGraficosRelatorio(resultados);
        }

        function atualizarGraficosRelatorio(resultados) {
            // Se Chart.js n√£o estiver dispon√≠vel, faz fila para executar quando carregar
            if (typeof Chart === 'undefined') {
                document.getElementById('chart-status').innerHTML = '<p>Carregando gr√°ficos...</p>';
                document.getElementById('chart-tecnicos').innerHTML = '<p>Carregando gr√°ficos...</p>';
                document.getElementById('chart-setores').innerHTML = '<p>Carregando gr√°ficos...</p>';
                document.getElementById('chart-maquinas').innerHTML = '<p>Carregando gr√°ficos...</p>';
                ensureChartJsLoaded(function() { atualizarGraficosRelatorio(resultados); });
                return;
            }

            try {
                // Contagens por status
                const statusCounts = [
                    resultados.filter(r => r.status === 'pendente').length,
                    resultados.filter(r => r.status === 'andamento').length,
                    resultados.filter(r => r.status === 'concluida').length,
                    resultados.filter(r => r.status === 'cancelada').length
                ];
                const statusLabels = ['Pendente', 'Em Andamento', 'Conclu√≠da', 'Cancelada'];

                // Contagens por t√©cnico
                const tecnicoLabels = tecnicos.map(t => t.nome);
                const tecnicoData = tecnicos.map(t => resultados.filter(r => r.tecnicoId === t.id).length);

                // Contagens por setor (din√¢mico a partir das OS no per√≠odo)
                const setores = Array.from(new Set(resultados.map(r => r.setor).filter(s => s && s.toString().trim() !== ''))).sort();
                const setorData = setores.map(s => resultados.filter(r => r.setor === s).length);

                // Destr√≥i gr√°ficos existentes
                if (chartStatusObj) { chartStatusObj.destroy(); chartStatusObj = null; }
                if (chartTecnicosObj) { chartTecnicosObj.destroy(); chartTecnicosObj = null; }
                if (chartSetoresObj) { chartSetoresObj.destroy(); chartSetoresObj = null; }

                const ctxStatus = document.getElementById('chart-status').getContext('2d');
                const gradStatus1 = ctxStatus.createLinearGradient(0,0,0,180);
                gradStatus1.addColorStop(0,'#ffd59a');
                gradStatus1.addColorStop(1,'#f39c12');
                chartStatusObj = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusCounts,
                            backgroundColor: ['#d00','#ff9f00','#2ecc71','#95a5a6'],
                            hoverOffset: 8
                        }]
                    },

                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: { size: 12 } } },
                            tooltip: { callbacks: { label: function(ctx){ return ctx.label + ': ' + ctx.formattedValue; } } }
                        },
                        layout: { padding: { top: 6, bottom: 6 } }
                    }
                });

                const ctxTec = document.getElementById('chart-tecnicos').getContext('2d');
                // Preparar dados por status para cada t√©cnico
                const pendData = tecnicos.map(t => resultados.filter(r => r.tecnicoId === t.id && r.status === 'pendente').length);
                const andData = tecnicos.map(t => resultados.filter(r => r.tecnicoId === t.id && r.status === 'andamento').length);
                const concData = tecnicos.map(t => resultados.filter(r => r.tecnicoId === t.id && r.status === 'concluida').length);

                // Desenha gr√°fico agrupado (3 datasets: Pendente, Em Andamento, Conclu√≠da)
                chartTecnicosObj = new Chart(ctxTec, {
                    type: 'bar',
                    data: {
                        labels: tecnicoLabels,
                        datasets: [
                            { label: 'Pendente', data: pendData, backgroundColor: '#f39c12' },
                            { label: 'Em Andamento', data: andData, backgroundColor: '#ff9f00' },
                            { label: 'Conclu√≠da', data: concData, backgroundColor: '#2ecc71' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { boxWidth: 12, font: { size: 12 } } },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 }, grid: { display: false } },
                            y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { precision: 0 } }
                        },
                        elements: { bar: { borderRadius: 6, borderSkipped: false } },
                        layout: { padding: { top: 6, bottom: 6 } }
                    }
                });

                // Gera mini-gr√°ficos por t√©cnico (doughnut) para cada t√©cnico
                try {
                    // Limpa anteriores
                    chartPorTecnicoObjs.forEach(c => { try { c.destroy(); } catch(e){} });
                    chartPorTecnicoObjs = [];
                    const container = document.getElementById('mini-charts-per-tecnico');
                    if (container) {
                        container.innerHTML = '';
                        tecnicos.forEach(tecnico => {
                            const tPend = resultados.filter(r => r.tecnicoId === tecnico.id && r.status === 'pendente').length;
                            const tAnd = resultados.filter(r => r.tecnicoId === tecnico.id && r.status === 'andamento').length;
                            const tConc = resultados.filter(r => r.tecnicoId === tecnico.id && r.status === 'concluida').length;
                            const total = tPend + tAnd + tConc;

                            const card = document.createElement('div');
                            card.className = 'mini-chart-card';
                            card.innerHTML = `<canvas></canvas><div class="mini-label">${tecnico.nome}</div><div class="mini-sub">Total: ${total}</div>`;
                            container.appendChild(card);

                            const cvs = card.querySelector('canvas');
                            const ctx = cvs.getContext('2d');

                            const ch = new Chart(ctx, {
                                type: 'doughnut',
                                data: { labels: ['Pendente','Andamento','Conclu√≠da'], datasets: [{ data: [tPend,tAnd,tConc], backgroundColor: ['#f39c12','#ff9f00','#2ecc71'] }] },
                                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx){ return ctx.label + ': ' + ctx.formattedValue; } } } } }
                            });

                            chartPorTecnicoObjs.push(ch);
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao gerar mini-gr√°ficos por t√©cnico:', e);
                    const container = document.getElementById('mini-charts-per-tecnico'); if (container) container.innerHTML = '<p>Erro ao gerar mini-gr√°ficos.</p>';
                }

                const ctxSet = document.getElementById('chart-setores').getContext('2d');
                const gradSet = ctxSet.createLinearGradient(0,0,0,180);
                gradSet.addColorStop(0,'#eaffc7');
                gradSet.addColorStop(1,'#39ff14');
                chartSetoresObj = new Chart(ctxSet, {
                    type: 'bar',
                    data: { labels: setores, datasets: [{ label: 'Quantidade de OS', data: setorData, backgroundColor: gradSet }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx){ return ctx.dataset.label + ': ' + ctx.formattedValue; } } } },
                        scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f0f0f0' } } },
                        elements: { bar: { borderRadius: 8, borderSkipped: false } },
                        layout: { padding: { top: 6, bottom: 6 } }
                    }
                });

                // Gr√°fico de M√°quinas (top 10)
                try { if (chartMaquinasObj) { chartMaquinasObj.destroy(); chartMaquinasObj = null; } } catch (e) {}
                const maquinaCountsMap = {};
                resultados.forEach(r => {
                    const id = r.maquinaId || null;
                    if (!id) return;
                    maquinaCountsMap[id] = (maquinaCountsMap[id] || 0) + 1;
                });
                const maquinasCountsArr = Object.entries(maquinaCountsMap).map(([id,count]) => {
                    const m = maquinas.find(x => x.id === id) || { nome: id, patrimonio: '' };
                    const label = `${m.nome}${m.patrimonio ? ' - ' + m.patrimonio : ''}`;
                    return { id, label, count };
                }).sort((a,b) => b.count - a.count).slice(0,10);

                const maquinaLabels = maquinasCountsArr.map(x => x.label);
                const maquinaData = maquinasCountsArr.map(x => x.count);

                const ctxMaq = document.getElementById('chart-maquinas').getContext('2d');
                const gradMaq = ctxMaq.createLinearGradient(0,0,0,160);
                gradMaq.addColorStop(0,'#80deea');
                gradMaq.addColorStop(1,'#00bcd4');
                chartMaquinasObj = new Chart(ctxMaq, {
                    type: 'bar',
                    data: { labels: maquinaLabels, datasets: [{ label: 'Quantidade de OS', data: maquinaData, backgroundColor: gradMaq }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx){ return ctx.dataset.label + ': ' + ctx.formattedValue; } } } },
                        scales: { x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 }, grid: { display: false } }, y: { beginAtZero: true, grid: { color: '#f0f0f0' } } },
                        elements: { bar: { borderRadius: 8, borderSkipped: false } },
                        layout: { padding: { top: 6, bottom: 6 } }
                    }
                });
            } catch (e) {
                console.error('Erro ao atualizar gr√°ficos:', e);
                document.getElementById('chart-status').innerHTML = '<p>Erro ao gerar gr√°fico.</p>';
                document.getElementById('chart-tecnicos').innerHTML = '<p>Erro ao gerar gr√°fico.</p>';
                document.getElementById('chart-setores').innerHTML = '<p>Erro ao gerar gr√°fico.</p>';
                document.getElementById('chart-maquinas').innerHTML = '<p>Erro ao gerar gr√°fico.</p>';
            }
        }

        function exportarRelatorioCSV() {
            if (!relatorioAtual || relatorioAtual.length === 0) { alert('Nenhum dado para exportar.'); return; }

            let csv = 'N√∫mero,Solicitante,Setor,Equipamento,Data,Status,T√©cnico\n';
            relatorioAtual.forEach(os => {
                const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
                const statusText = os.status === 'pendente' ? 'Pendente' : os.status === 'andamento' ? 'Em Andamento' : os.status === 'concluida' ? 'Conclu√≠da' : 'Cancelada';
                csv += `"#${os.numero}","${solicitante.nome || ''}","${os.setor}","${os.equipamento}","${formatarData(os.data)}","${statusText}","${tecnico.nome || ''}"\n`;
            });

            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `relatorio_os.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportarRelatorioTecnicosCSV() {
            const tbody = document.querySelector('#tabela-tecnicos-resumo tbody');
            if (!tbody || !tbody.querySelector('tr')) { alert('Nenhum dado para exportar.'); return; }

            let csv = 'T√©cnico,Pendentes,Conclu√≠das,Total\n';
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                const cols = tr.querySelectorAll('td');
                if (cols.length < 4) return;
                const nome = cols[0].innerText.replace(/"/g, '""');
                csv += `"${nome}",${cols[1].innerText},${cols[2].innerText},${cols[3].innerText}\n`;
            });

            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `relatorio_tecnicos.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function imprimirRelatorio() {
            if (!relatorioAtual) return;
            const originalContents = document.body.innerHTML;
            const printContents = document.getElementById('relatorios').innerHTML;

            document.body.innerHTML = `
                <h1>Relat√≥rio de OS</h1>
                ${printContents}
                <p>Gerado em: ${new Date().toLocaleDateString('pt-BR')}</p>
            `;

            window.print();
            document.body.innerHTML = originalContents;
        }

        // Abre o relat√≥rio atual em uma nova janela (visualiza√ß√£o)
        function abrirRelatorioNovaJanela() {
            const relDiv = document.getElementById('relatorios');
            if (!relDiv) return alert('√Årea de relat√≥rios n√£o encontrada.');
            const summaryHtml = document.getElementById('relatorio-summary') ? document.getElementById('relatorio-summary').outerHTML : '';
            const tableHtml = document.getElementById('tabela-relatorio') ? document.getElementById('tabela-relatorio').outerHTML : '';

            // Captura imagens dos gr√°ficos (Chart.js ou canvas) com fallback
            function getChartImage(chartObj, selector) {
                try {
                    if (chartObj && typeof chartObj.toBase64Image === 'function') return chartObj.toBase64Image();
                    const elCanvas = document.querySelector(selector + ' canvas') || document.querySelector(selector + ' canvas');
                    if (elCanvas && typeof elCanvas.toDataURL === 'function') return elCanvas.toDataURL();
                } catch (e) { /* ignore */ }
                return null;
            }
            const statusImg = getChartImage(typeof chartStatusObj !== 'undefined' ? chartStatusObj : null, '#chart-status');
            const tecImg = getChartImage(typeof chartTecnicosObj !== 'undefined' ? chartTecnicosObj : null, '#chart-tecnicos');
            const setImg = getChartImage(typeof chartSetoresObj !== 'undefined' ? chartSetoresObj : null, '#chart-setores');
            const maqImg = getChartImage(typeof chartMaquinasObj !== 'undefined' ? chartMaquinasObj : null, '#chart-maquinas');

            let chartsHtml = '<div style="display:flex;flex-wrap:wrap;gap:12px;margin:12px 0;">';
            if (statusImg) chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por Status</h3><img src="${statusImg}" style="max-width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fff"></div>`;
            else chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por Status</h3><p>Gr√°fico indispon√≠vel</p></div>`;
            if (tecImg) chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por T√©cnico</h3><img src="${tecImg}" style="max-width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fff"></div>`;
            else chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por T√©cnico</h3><p>Gr√°fico indispon√≠vel</p></div>`;
            if (setImg) chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por Setor</h3><img src="${setImg}" style="max-width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fff"></div>`;
            else chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por Setor</h3><p>Gr√°fico indispon√≠vel</p></div>`;
            if (maqImg) chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por M√°quina</h3><img src="${maqImg}" style="max-width:100%;height:auto;border:1px solid #ddd;padding:4px;background:#fff"></div>`;
            else chartsHtml += `<div style="flex:1;min-width:220px"><h3 style="margin:6px 0;color:#00843d">OS por M√°quina</h3><p>Gr√°fico indispon√≠vel</p></div>`;
            chartsHtml += '</div>';

            const html = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8"><title>Relat√≥rio de OS</title><style>body{font-family:Arial,sans-serif;margin:20px}h1{color:#00843d}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px;text-align:left}.print-btn{display:inline-block;padding:8px 14px;background:#39ff14;color:#111;border-radius:6px;border:none;font-weight:bold;cursor:pointer;margin-bottom:12px}</style></head><body><h1>Relat√≥rio de OS</h1><p>Gerado em: ${new Date().toLocaleString()}</p><button class="print-btn" onclick="window.print()">Imprimir Relat√≥rio</button>${chartsHtml}${summaryHtml}${tableHtml}</body></html>`;
            const novaJanela = window.open('', '_blank');
            if (!novaJanela) { alert('N√£o foi poss√≠vel abrir a nova janela. Verifique o bloqueador de pop-ups.'); return; }
            novaJanela.document.write(html);
            novaJanela.document.close();
        }

        function gerarRelatorioCompleto() {
            gerarRelatorio('completo');
        }
        
        function exportarHistoricoExcel() {
            let csv = 'N√∫mero,Solicitante,Setor,Equipamento,Data,Status,T√©cnico\n';
            
            const filtroSetor = document.getElementById('historico-setor').value;
            const periodo = parseInt(document.getElementById('historico-periodo').value);
            
            let hoje = new Date();
            let dataLimite = new Date();
            if (periodo > 0) {
                dataLimite.setDate(hoje.getDate() - periodo);
            }
            
            ordensServico.forEach(os => {
                // Aplica filtros
                if (filtroSetor && os.setor !== filtroSetor) return;
                if (periodo > 0) {
                    const dataOS = new Date(os.data);
                    if (dataOS < dataLimite) return;
                }
                
                const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
                const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
                
                const statusText = os.status === 'pendente' ? 'Pendente' :
                                  os.status === 'andamento' ? 'Em Andamento' :
                                  os.status === 'concluida' ? 'Conclu√≠da' : 'Cancelada';
                
                csv += `"#${os.numero}","${solicitante.nome || ''}","${os.setor}","${os.equipamento}","${formatarData(os.data)}","${statusText}","${tecnico.nome || ''}"\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'historico_os.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function imprimirHistorico() {
            const originalContents = document.body.innerHTML;
            const printContents = document.getElementById('historico-os').innerHTML;
            
            document.body.innerHTML = `
                <h1>Relat√≥rio de Hist√≥rico de OS</h1>
                ${printContents}
                <p>Gerado em: ${new Date().toLocaleDateString('pt-BR')}</p>
            `;
            
            window.print();
            document.body.innerHTML = originalContents;
        }

        // Fun√ß√µes utilit√°rias
        function formatarData(dataString) {
            if (!dataString) return '';
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dataString).toLocaleDateString('pt-BR', options);
        }

        // Fun√ß√£o para abrir OS em nova p√°gina
function abrirOSNovaPagina(osId) {
    const os = ordensServico.find(o => o.id === osId);
    if (!os) return;
    const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
    const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
    let statusText = os.status === 'pendente' ? 'Pendente' :
        os.status === 'andamento' ? 'Em Andamento' :
        os.status === 'concluida' ? 'Conclu√≠da' : 'Cancelada';
    // Fun√ß√£o para formatar data no padr√£o dd/mm/yyyy
    function formatarDataInput(dataString) {
        if (!dataString) return '';
        const [ano, mes, dia] = dataString.split('-');
        return `${dia}/${mes}/${ano}`;
    }
    // Diagn√≥stico t√©cnico
    let diagnosticoHtml = '';
    if (os.diagnostico && os.diagnostico.trim() !== '') {
        diagnosticoHtml = `<p>${os.diagnostico.replace(/\n/g, '<br>')}</p>`;
    } else {
        diagnosticoHtml = `<p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p><p style="min-height:24px; border-bottom:1px solid #ccc;"></p>`;
    }
    // Solu√ß√£o aplicada
    let solucaoHtml = '';
    if (os.solucao && os.solucao.trim() !== '') {
        solucaoHtml = `<p>${os.solucao.replace(/\n/g, '<br>')}</p>`;
    } else {
        solucaoHtml = `<p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p><p style="min-height:24px; border-bottom:1px solid #ccc;"></p>`;
    }
    const html = `<!DOCTYPE html>
<html lang='pt-BR'>
<head>
    <meta charset='UTF-8'>
    <title>Ordem de Servi√ßo #${os.numero}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
        .os-container {
            max-width: 600px;
            margin: 16px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 6px #0001;
            padding: 18px 22px 12px 22px;
            font-size: 13px;
        }
        .os-header { text-align: center; margin-bottom: 12px; }
        .os-header h1 { color: #00843d; margin-bottom: 2px; font-size: 1.2em; }
        .os-header .subtitle { color: #666; font-size: 1em; }
        .os-info { display: flex; gap: 10px; margin-bottom: 10px; }
        .os-info-block { flex: 1; border: 1px solid #ddd; padding: 7px 10px; border-radius: 4px; }
        .os-info-block h3 { margin: 0 0 4px 0; color: #00843d; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .os-details { margin-bottom: 8px; }
        .os-details h3 { color: #00843d; font-size: 1em; margin: 0 0 2px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .os-details p { white-space: pre-line; margin: 0 0 2px 0; }
        .os-signatures { display: flex; gap: 20px; margin-top: 18px; }
        .os-signature { border-top: 1px solid #000; padding-top: 6px; text-align: center; font-size: 0.95em; }
        .print-button {
            display: block;
            margin: 16px auto 0 auto;
            padding: 8px 18px;
            background: #39ff14;
            color: #111;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
        }
        @media print {
            body { background: #fff; }
            .print-button { display: none; }
            .os-container { box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>
    <div class='os-container'>
        <div class='os-header'>
            <h1>ORDEM DE SERVI√áO #${os.numero}</h1>
            <div class='subtitle'>${statusText} - ${formatarDataInput(os.data)}</div>
        </div>
        <div class='os-info'>
            <div class='os-info-block'>
                <h3>Solicitante</h3>
                <p><strong>Nome:</strong> ${solicitante.nome || 'N√£o informado'}</p>
                <p><strong>Setor:</strong> ${os.setor || 'N√£o informado'}</p>
                <p><strong>Contato:</strong> ${solicitante.contato || 'N√£o informado'}</p>
            </div>
            <div class='os-info-block'>
                <h3>Servi√ßo</h3>
                <p><strong>Equipamento:</strong> ${os.equipamento}</p>
                <p><strong>Patrim√¥nio:</strong> ${os.serial || 'N√£o informado'}</p>
                <p><strong>T√©cnico:</strong> ${tecnico.nome || 'N√£o informado'} (${tecnico.especialidade || 'N√£o informado'})</p>
                <p><strong>Prazo:</strong> ${os.prazo ? formatarDataInput(os.prazo) : 'N√£o definido'}</p>
            </div>
        </div>
        <div class='os-details'>
            <h3>Problema Relatado</h3>
            <p>${os.problema}</p>
        </div>
        <div class='os-details'>
            <h3>Diagn√≥stico T√©cnico</h3>
            ${diagnosticoHtml}
        </div>
        <div class='os-details'>
            <h3>Solu√ß√£o Aplicada</h3>
            ${solucaoHtml}
        </div>
        <div class='os-details os-times'>
            <h3>Hor√°rio do Servi√ßo</h3>
            ${ (os.servicos && os.servicos.length) ? os.servicos.map(s => `
                <div style="margin-bottom:10px;">
                    <strong>${s}</strong>
                    <div style="margin-top:6px;">
                        <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px;"></span> <small>Hora In√≠cio</small>
                        <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px; margin-left:24px;"></span> <small>Hora T√©rmino</small>
                    </div>
                </div>
            `).join('') : `
                <div style="margin-top:6px;">
                    <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px;"></span> <small>Hora In√≠cio</small>
                    <span style="display:inline-block; min-width:160px; border-bottom:1px solid #000; padding-bottom:6px; margin-left:24px;"></span> <small>Hora T√©rmino</small>
                </div>
            ` }
        </div>
        <div class='os-signatures'>
            <div class='os-signature'>
                <p>______________________________</p>
                <p>Assinatura do Solicitante</p>
            </div>
            <div class='os-signature'>
                <p>______________________________</p>
                <p>Assinatura do T√©cnico</p>
            </div>
        </div>
        <button class='print-button' onclick='window.print()'>Imprimir OS</button>
    </div>
</body>
</html>`;
    const novaJanela = window.open('', '_blank');
    if (!novaJanela) {
        alert('N√£o foi poss√≠vel abrir a nova janela. Verifique se o bloqueador de pop-ups est√° ativado.');
        return;
    }
    // Aguarda a nova janela carregar antes de escrever o conte√∫do
    novaJanela.document.write(html);
    novaJanela.document.close();
    // Garante que o conte√∫do seja renderizado antes de chamar print (em navegadores que suportam)
    novaJanela.onload = function() {
        novaJanela.focus();
    };
    // Fallback para browsers que n√£o disparam onload corretamente
    setTimeout(function() {
        novaJanela.focus();
    }, 300);
}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
